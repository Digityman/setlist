<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Live Music Archive ‚Äî Mobile Player</title>
<link rel="preconnect" href="https://archive.org">
<style>
  /* ===== Mobile-first foundation ===== */
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#000; --text:#fff; --muted:#cbd5e1; --chip:#334155;
    --panel:rgba(255,255,255,.07); --pill:rgba(255,255,255,.15);
    --wavePast:#b06cff; --waveFuture:#d1d5db;
    --tap:44px;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    -webkit-text-size-adjust:100%; text-size-adjust:100%;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  img{max-width:100%;height:auto;-webkit-user-drag:none;user-select:none}
  a{color:#c6e1ff;text-decoration:none}
  .hidden{display:none!important}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  header.main{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;flex-wrap:wrap}
  h1{margin:0;font-size:22px;font-weight:900;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .sub{color:var(--muted);font-size:12px}
  .btn{
    padding:8px 12px; min-height:var(--tap); min-width:var(--tap);
    border-radius:12px;background:var(--pill);color:var(--text);border:0;cursor:pointer
  }
  .btn[aria-pressed="true"]{background:#fbbf24;color:#111}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  label{display:block;font-size:12px;font-weight:600;margin:0 0 6px}
  .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap}
  select,input[type="text"]{
    width:100%;display:block;padding:12px;border-radius:12px;border:0;
    background:var(--pill);color:#fff;font-size:14px;min-height:var(--tap)
  }
  select option{background:#111;color:#fff}
  .chip{background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;line-height:1;display:inline-flex;align-items:center;white-space:nowrap}

  /* ===== Sticky Player ===== */
  .playerSticky{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.6));backdrop-filter:blur(4px);padding:8px 0 10px}
  .playerBar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  @media (max-width:860px){.playerBar{grid-template-columns:1fr}}
  .pill{background:var(--pill);border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:10px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .seekWrap{position:relative;display:flex;align-items:center;gap:8px;flex:1;min-width:240px}
  #P_seekVis{position:absolute;left:10px;right:108px;top:50%;height:18px;transform:translateY(-50%);pointer-events:none}
  .range{width:100%}
  #P_times{display:flex;gap:8px;min-width:92px;justify-content:flex-end}
  .loading{display:none;width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #P_audio{display:none}

  /* ===== Views ===== */
  .views{display:grid;grid-template-columns:360px 1fr;gap:24px}
  @media (max-width:980px){.views{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:16px;padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
  .list{height:68vh;overflow:auto;margin-top:10px;border-radius:10px;-webkit-overflow-scrolling:touch}

  .row{width:100%;text-align:left;padding:10px;border:0;background:transparent;color:inherit;cursor:pointer;border-radius:10px}
  .row:hover{background:rgba(255,255,255,.08)}
  .title{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{color:#cbd5e1;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
  .subrow{display:flex;align-items:center;gap:8px;margin-top:6px} .subrow .spacer{flex:1}
  .stars{color:#fbbf24}
  .fav{color:#60a5fa;opacity:.45;font-size:18px} .fav.on{opacity:1}

  .infoTop{display:flex;align-items:center;gap:10px;margin:8px 0 4px}
  #C_favBtn{padding:8px 12px;margin-right:6px}
  #C_info h3{margin:0;font-size:18px}
  .pillrow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .trackPane{display:flex;flex-direction:column;min-height:0}
  #C_trackScroll{flex:1 1 0;min-height:0;overflow:auto;border-radius:10px;-webkit-overflow-scrolling:touch}

  .track{display:grid;grid-template-columns:28px 1fr auto;gap:8px;align-items:center;padding:6px;border-radius:8px;cursor:pointer}
  .track:hover{background:rgba(255,255,255,.08)} .track.on{background:rgba(255,255,255,.15)}
  .tidx{width:28px;text-align:right;color:#cbd5e1}
  .tname{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:6px}
  .ttime{color:#cbd5e1;font-size:12px;display:flex;align-items:center;gap:6px}
  .ttime .spinner{display:none;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin .9s linear infinite}
  .track.loading .ttime .spinner{display:inline-block}
  .eq{display:none;gap:2px;align-items:flex-end;margin-left:2px}
  .track.on .eq{display:inline-flex}
  .eq i{width:3px;height:10px;background:#fbbf24;display:block;transform-origin:bottom center;animation:bar 1s ease-in-out infinite}
  .eq i:nth-child(2){animation-delay:.15s} .eq i:nth-child(3){animation-delay:.30s}
  @keyframes bar{0%,100%{transform:scaleY(.5)}50%{transform:scaleY(1)}}

  /* ===== Bands landing ===== */
  .bandsWrap{display:grid;grid-template-columns:1fr 1fr 2fr auto;gap:8px;margin-bottom:10px}
  @media (max-width:900px){.bandsWrap{grid-template-columns:1fr 1fr;grid-auto-rows:auto}}
  .gridBands{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
  .bandCard{background:var(--panel);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;position:relative;min-width:0}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:8px;object-fit:cover;background:#0e1116}
  .bandTitle{font-weight:700;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bandMeta{display:flex;gap:6px;align-items:center;font-size:10px;color:#e5e7eb}
  .favBand{position:absolute;top:6px;right:6px;font-size:18px;color:#60a5fa;opacity:.45;cursor:pointer;user-select:none;z-index:2}
  .favBand.on{opacity:1}
  .cardLink{position:absolute;inset:0;border-radius:12px;z-index:1}

  /* ===== Continue listening toast ===== */
  .toast{position:fixed;left:16px;bottom:16px;z-index:40;display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 10px;backdrop-filter:blur(4px)}
  .toast .sub{max-width:70vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (prefers-reduced-motion:reduce){.eq i{animation:none}}
</style>
<link rel="manifest" href="/setlist/manifest.json">
<meta name="theme-color" content="#000000">
<script>
if ('serviceWorker' in navigator) {
  // IMPORTANT: use the public URL path, including /setlist/
  navigator.serviceWorker.register('/setlist/sw.js');
}
</script>
</head>
<body>
<div class="wrap">
  <header class="main">
    <div>
      <h1 id="hdr">
        Live Music Archive ‚Äî Bands
        <button id="hdrBandFav" class="btn hidden" title="Favorite band">‚òÜ</button>
      </h1>
      <div id="sub" class="sub">Top collections ¬∑ tap a band to browse concerts</div>
    </div>
    <button id="navBands" class="btn" title="Bands / Back">‚Ü©Ô∏é Bands</button>
  </header>

  <!-- Sticky Player -->
  <div class="playerSticky">
    <div class="playerBar">
      <div class="pill">
        <div class="controls">
          <button id="P_prev" class="btn" title="Previous">‚èÆ</button>
          <button id="P_back10" class="btn" title="Back 10s">‚Ü∂10</button>
          <button id="P_play" class="btn" title="Play/Pause">‚ñ∂</button>
          <button id="P_fwd10" class="btn" title="Forward 10s">10‚Ü∑</button>
          <button id="P_next" class="btn" title="Next">‚è≠</button>
          <button id="P_repeat" class="btn" aria-pressed="false" title="Repeat concert">‚ü≤</button>
          <button id="P_shuffle" class="btn" aria-pressed="false" title="Shuffle">‚áÑ</button>
        </div>
        <div class="seekWrap">
          <label for="P_seek" class="sr-only">Seek</label>
          <canvas id="P_seekVis" height="18" aria-hidden="true"></canvas>
          <input id="P_seek" type="range" class="range" min="0" max="0" value="0" title="Seek position">
          <div id="P_times" class="sub"><span id="P_cur">0:00</span><span id="P_dur">0:00</span></div>
          <span id="P_loading" class="loading" role="status" aria-label="Buffering‚Ä¶"></span>
        </div>
      </div>
      <div class="pill" style="gap:10px;align-items:center;min-width:240px">
        <button id="P_vdown" class="btn" title="Volume down">üîà</button>
        <label for="P_vol" class="sr-only">Volume</label>
        <input id="P_vol" type="range" min="0" max="1" step="0.01" value="0.7" style="width:140px" title="Volume">
        <span id="P_pct" class="sub" style="min-width:32px;text-align:right">70%</span>
        <button id="P_vup" class="btn" title="Volume up">üîä</button>
        <button id="P_mute" class="btn" aria-pressed="false" title="Mute">üîá</button>
      </div>
    </div>
    <audio id="P_audio" crossorigin="anonymous"></audio>
  </div>

  <!-- Continue listening toast -->
  <div id="listenToast" class="toast hidden">
    <button id="listenToastBtn" class="btn" title="Resume">‚ñ∂</button>
    <div id="listenToastInfo" class="sub">Continue listening‚Ä¶</div>
    <button id="listenToastClose" class="btn" title="Dismiss">‚úï</button>
  </div>

  <!-- Bands (landing) -->
  <section id="V_bands">
    <div class="bandsWrap">
      <div><label for="B_sort">Sort</label>
        <select id="B_sort">
          <option value="downloads desc">Views ‚Üì</option>
          <option value="downloads asc">Views ‚Üë</option>
          <option value="title asc">Title A‚ÄìZ</option>
          <option value="title desc">Title Z‚ÄìA</option>
        </select>
      </div>
      <div><label for="B_subject">Subject</label><select id="B_subject"><option value="*">All subjects</option></select></div>
      <div><label for="B_q">Search</label><input id="B_q" type="text" placeholder="e.g., Grateful Dead, bluegrass"></div>
      <div style="align-self:end;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
        <button id="B_favToggle" class="btn" aria-pressed="false">‚òÖ Favorites</button>
        <button id="B_reset" class="btn">Reset</button>
      </div>
    </div>
    <div class="toolbar">
      <div class="sub"><span id="B_count">‚Äî</span> ¬∑ Showing top 100</div>
      <div class="sub" id="B_diag"></div>
    </div>
    <div id="B_grid" class="gridBands"></div>
  </section>

  <!-- Concerts -->
  <section id="V_concerts" class="hidden">
    <div class="views">
      <aside class="card">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label for="C_year">Year <span id="C_yearProg" class="sub"></span></label><select id="C_year" title="Select year"></select></div>
          <div><label for="C_sort">Sort</label>
            <select id="C_sort" title="Sort concerts">
              <option value="date asc">Date ‚Üë</option><option value="date desc">Date ‚Üì</option>
              <option value="avg_rating desc">Rating ‚Üì</option><option value="avg_rating asc">Rating ‚Üë</option>
              <option value="num_reviews desc">Reviews ‚Üì</option><option value="num_reviews asc">Reviews ‚Üë</option>
              <option value="title asc">Title A‚ÄìZ</option><option value="title desc">Title Z‚ÄìA</option>
            </select>
          </div>
          <div style="grid-column:1/-1"><label for="C_filter">Filter (venue/city/title)</label><input id="C_filter" type="text" placeholder="e.g., Winterland, San Francisco"></div>
        </div>

        <div class="toolbar">
          <div><span id="C_count" class="sub">‚Äî</span><span id="C_diag" class="sub"></span></div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="C_favToggle" class="btn" aria-pressed="false">‚òÖ Favorites</button>
            <button id="C_reset" class="btn">Reset</button>
          </div>
        </div>

        <div id="C_list" class="list"><div class="sub" style="padding:12px">Loading concerts‚Ä¶</div></div>
      </aside>

      <main class="card trackPane">
        <section id="C_info" class="hidden">
          <div class="infoTop">
            <button id="C_favBtn" class="btn" aria-pressed="false" title="Mark as favorite">‚òÜ</button>
            <h3 id="C_title"></h3>
          </div>
          <div class="pillrow"><span id="C_venue" class="chip"></span><span id="C_ident" class="chip"></span></div>
        </section>

        <div id="C_tracksLoad" class="sub hidden" style="display:flex;align-items:center;gap:8px"><span class="loadingDot"></span> Loading tracks‚Ä¶</div>

        <section id="C_tracks" class="hidden" style="margin-top:12px">
          <h3>Tracks</h3>
          <div id="C_trackScroll"><div id="C_trackList"></div></div>
        </section>

        <div id="C_placeholder" class="sub">Pick a concert to start listening.</div>
      </main>
    </div>
  </section>
</div>

<script>
/* ===== Utilities ===== */
const $=id=>document.getElementById(id);
const on=(el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const pad2=n=>String(n).padStart(2,'0');
const timeStr=s=>(!s||isNaN(s))?'0:00':`${Math.floor(s/60)}:${pad2(Math.floor(s%60))}`;
const fmt=n=>Number(n||0).toLocaleString();
const fmtCompact=n=>{try{return Intl.NumberFormat('en',{notation:'compact',maximumFractionDigits:1}).format(n||0)}catch(e){return String(n||0)}}
const niceFromId=s=>String(s||'').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/_/g,' ').trim();
function setRangeFill(el,f,color=getComputedStyle(document.documentElement).getPropertyValue('--wavePast')||'#b06cff'){if(!el)return;const p=Math.round(clamp(f,0,1)*100);el.style.background=`linear-gradient(to right, ${color} ${p}%, rgba(255,255,255,.25) ${p}%)`;}
function setBrandColor(collection){let h=0;for(const ch of collection)h=(h*31+ch.charCodeAt(0))>>>0;document.documentElement.style.setProperty('--wavePast',`hsl(${h%360} 65% 60%)`);}
function jsonp(url,timeout=20000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const s=document.createElement('script');
    const done=(ok,d)=>{delete window[cb];s.remove();ok?res(d):rej(d)};
    const t=setTimeout(()=>done(false,new Error('timeout')),timeout);
    window[cb]=d=>{clearTimeout(t);done(true,d)};
    s.onerror=()=>{clearTimeout(t);done(false,new Error('net'))};
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    document.body.appendChild(s);
  });
}

/* ===== Global App State (persisted) ===== */
const APP={
  view:'bands',
  collection:'', collectionName:'',
  lastConcertId:'', lastConcertTitle:'',
  lastTrackIdx:-1,
  wantOpenIdentifier:'',
  markTrackLoading:()=>{}, ensureTrackVisible:()=>{}
};
function saveCtx(){
  localStorage.setItem('lma:ctx',JSON.stringify({
    collection:APP.collection, collectionName:APP.collectionName,
    lastConcertId:APP.lastConcertId, lastConcertTitle:APP.lastConcertTitle,
    lastTrackIdx:APP.lastTrackIdx
  }));
}
(function restoreCtx(){
  try{
    const c=JSON.parse(localStorage.getItem('lma:ctx')||'{}');
    APP.collection=c.collection||''; APP.collectionName=c.collectionName||'';
    APP.lastConcertId=c.lastConcertId||''; APP.lastConcertTitle=c.lastConcertTitle||''; APP.lastTrackIdx=Number.isInteger(c.lastTrackIdx)?c.lastTrackIdx:-1;
  }catch{}
})();

/* ===== Static waveform (lightweight) ===== */
const WAVE=(()=>{let cvs=null,ctx=null,amps=null,progress=0,lastUrl='',aborter=null;
  const FUT=()=>getComputedStyle(document.documentElement).getPropertyValue('--waveFuture')||'#d1d5db';
  const PAST=()=>getComputedStyle(document.documentElement).getPropertyValue('--wavePast')||'#b06cff';
  const get=()=>{if(cvs&&cvs.isConnected)return cvs; cvs=$('P_seekVis'); ctx=cvs?cvs.getContext('2d'):null; return cvs;}
  function bins(){const cv=get(); if(!cv) return 0; const w=Math.max(200,(cv.parentElement?.clientWidth||320)-110); cv.width=w; cv.height=18; return w;}
  function norm(arr){let m=0;for(let i=0;i<arr.length;i++) m=Math.max(m,arr[i]); if(!m) return arr.fill(0); for(let i=0;i<arr.length;i++) arr[i]/=m; return arr;}
  function ampsFrom(ab,N){const ch=ab.numberOfChannels,len=ab.length,step=Math.max(1,Math.floor(len/N)); const out=new Float32Array(N);
    for(let b=0;b<N;b++){const st=b*step,en=Math.min(len,st+step); let pk=0; for(let i=st;i<en;i+=64){let s=0;for(let c=0;c<ch;c++) s+=(ab.getChannelData(c)[i]||0); pk=Math.max(pk,Math.abs(s/ch));} out[b]=pk;} return norm(out);}
  function drawBase(){const cv=get(); if(!cv||!ctx) return; const w=cv.width,h=cv.height,m=h/2; ctx.clearRect(0,0,w,h); ctx.strokeStyle=FUT(); ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,m); ctx.lineTo(w,m); ctx.stroke();}
  function draw(){const cv=get(); if(!cv||!ctx) return; const w=cv.width,h=cv.height,m=h/2; ctx.clearRect(0,0,w,h); if(!amps||!amps.length) return drawBase();
    const upto=Math.max(0,Math.min(w,Math.floor(progress*w)));
    ctx.fillStyle=FUT(); ctx.beginPath(); ctx.moveTo(0,m); for(let x=0;x<w;x++) ctx.lineTo(x,m-amps[x]*(m*.95)); for(let x=w-1;x>=0;x--) ctx.lineTo(x,m+amps[x]*(m*.95)); ctx.closePath(); ctx.fill();
    if(upto>0){ctx.fillStyle=PAST(); ctx.beginPath(); ctx.moveTo(0,m); for(let x=0;x<upto;x++) ctx.lineTo(x,m-amps[x]*(m*.95)); for(let x=upto-1;x>=0;x--) ctx.lineTo(x,m+amps[x]*(m*.95)); ctx.closePath(); ctx.fill();}
  }
  async function build(url){
    const w=bins(); if(!w){amps=null; lastUrl=url; return;}
    if(url===lastUrl&&amps&&amps.length===w){draw();return;}
    lastUrl=url; amps=null; drawBase();
    if(aborter) aborter.abort(); aborter=new AbortController();
    try{
      const head=await fetch(url,{method:'HEAD',mode:'cors'});
      const len=+head.headers.get('content-length')||0;
      if(len>15*1024*1024){ amps=null; drawBase(); return; } /* keep light on phones */
      const res=await fetch(url,{mode:'cors',signal:aborter.signal}); const buf=await res.arrayBuffer();
      const ac=new (window.AudioContext||window.webkitAudioContext)(); const dec=await ac.decodeAudioData(buf);
      amps=ampsFrom(dec,w); ac.close(); draw();
    }catch{ amps=null; drawBase(); }
  }
  function prog(p){progress=(Number.isFinite(p)?Math.max(0,Math.min(1,p)):0); draw()}
  function resize(){if(!get())return; if(amps){const old=amps,nw=bins(); if(!nw) return; const r=new Float32Array(nw); for(let x=0;x<nw;x++) r[x]=old[Math.floor((x/nw)*old.length)]||0; amps=r;} else {bins();} draw()}
  addEventListener('resize',resize,{passive:true});
  return{build,progress:prog,resize};
})();

/* ===== Player ===== */
const PLAYER=(()=>{const audio=$('P_audio'),seek=$('P_seek'),cur=$('P_cur'),dur=$('P_dur'),load=$('P_loading');
  const prev=$('P_prev'),back10=$('P_back10'),fwd10=$('P_fwd10'),play=$('P_play'),next=$('P_next'),rep=$('P_repeat'),shuf=$('P_shuffle');
  const vdown=$('P_vdown'),vup=$('P_vup'),vol=$('P_vol'),pct=$('P_pct'),mute=$('P_mute');
  const state={queue:[],idx:-1,repeat:false,shuffle:false,preMute:0.7,playing:false};
  const listeners=new Set(); const emit=()=>listeners.forEach(fn=>fn(state.idx));
  function persist(){localStorage.setItem('lma:player',JSON.stringify({repeat:state.repeat,shuffle:state.shuffle,vol:audio.volume,muted:audio.muted}))}
  ;(function restore(){try{const p=JSON.parse(localStorage.getItem('lma:player')||'{}'); setRepeat(!!p.repeat); setShuffle(!!p.shuffle); setVolume(typeof p.vol==='number'?p.vol:parseFloat(localStorage.getItem('gd:vol')||'0.7'),false); if(p.muted) toggleMute(true);}catch{}})();
  function showLoad(on){if(load) load.style.display=on?'inline-flex':'none'; if(play) play.disabled=!!on}
  function setRepeat(on){state.repeat=on; rep&&rep.setAttribute('aria-pressed',String(on)); persist()}
  function setShuffle(on){state.shuffle=on; shuf&&shuf.setAttribute('aria-pressed',String(on)); persist()}
  function setVolume(v,save=true){v=clamp(v,0,1); if(!audio) return; audio.volume=v; if(vol) vol.value=String(v); if(pct) pct.textContent=Math.round(v*100)+'%'; if(save){localStorage.setItem('gd:vol',String(v));persist()} if(v>0&&audio.muted){audio.muted=false; mute&&mute.setAttribute('aria-pressed','false'); persist()} setRangeFill(vol,v)}
  function toggleMute(force){if(!audio) return; audio.muted=(typeof force==='boolean')?force:!audio.muted; if(mute) mute.setAttribute('aria-pressed',String(audio.muted)); if(audio.muted){state.preMute=+(vol?.value||0.7); if(vol) vol.value='0'; if(pct) pct.textContent='0%';} else {setVolume(state.preMute||0.7,false)} persist()}
  function loadQueue(list,startIdx){state.queue=list||[]; playAt(clamp(startIdx??0,0,Math.max(0,state.queue.length-1)))}
  function playAt(i){
    if(!state.queue.length||!audio) return;
    state.idx=clamp(i,0,state.queue.length-1);
    const t=state.queue[state.idx];
    APP.markTrackLoading(true); showLoad(true);
    audio.src=t.url; WAVE.build(t.url);
    audio.play().catch(()=>{});
    APP.lastTrackIdx=state.idx; saveCtx(); emit();
  }
  function resume(){if(audio?.src){showLoad(true);audio.play().catch(()=>{})}} function pause(){audio?.pause()}
  function nextTrack(){if(!state.queue.length) return; if(state.shuffle){let n=Math.floor(Math.random()*state.queue.length); if(state.queue.length>1&&n===state.idx)n=(n+1)%state.queue.length; playAt(n)} else if(state.idx<state.queue.length-1) playAt(state.idx+1); else if(state.repeat) playAt(0)}
  on(play,'click',()=>state.playing?pause():resume());
  on(prev,'click',()=>{if(state.idx>0)playAt(state.idx-1)});
  on(back10,'click',()=>{if(!audio)return; audio.currentTime=Math.max(0,(audio.currentTime||0)-10)});
  on(fwd10,'click',()=>{if(!audio)return; audio.currentTime=Math.min((audio.duration||0),(audio.currentTime||0)+10)});
  on(next,'click',nextTrack);
  on(rep,'click',()=>setRepeat(!state.repeat)); on(shuf,'click',()=>setShuffle(!state.shuffle));
  on(vdown,'click',()=>setVolume((audio?.volume||0)-0.10)); on(vup,'click',()=>setVolume((audio?.volume||0)+0.10)); on(vol,'input',e=>setVolume(+e.target.value)); on(mute,'click',()=>toggleMute());
  on(audio,'timeupdate',()=>{if(!audio)return; if(seek){seek.max=audio.duration||0; seek.value=audio.currentTime||0;} if(cur) cur.textContent=timeStr(audio.currentTime); if(dur) dur.textContent=timeStr(audio.duration); const f=(audio.currentTime||0)/Math.max(1,(audio.duration||1)); setRangeFill(seek,f); WAVE.progress(f);});
  on(seek,'input',e=>{if(!audio)return; audio.currentTime=+e.target.value; setRangeFill(seek,(audio.currentTime||0)/(audio.duration||1))});
  ['loadstart','waiting','seeking'].forEach(ev=>on(audio,ev,()=>{showLoad(true);APP.markTrackLoading(true)}));
  ['playing','canplay','canplaythrough'].forEach(ev=>on(audio,ev,()=>{showLoad(false);APP.markTrackLoading(false);state.playing=true; if(play) play.textContent='‚è∏'}));
  on(audio,'pause',()=>{state.playing=false; if(play) play.textContent='‚ñ∂'; showLoad(false); APP.markTrackLoading(false)});
  on(audio,'ended',nextTrack);
  setRangeFill(vol,+(vol?.value||0.7)); setRangeFill(seek,0);
  return{load:loadQueue,onChange:(fn)=>listeners.add(fn),state};
})();

/* ===== Concerts ===== */
const C=(()=>{const $el={
  year:$('C_year'),yearProg:$('C_yearProg'),sort:$('C_sort'),filter:$('C_filter'),favToggle:$('C_favToggle'),reset:$('C_reset'),
  list:$('C_list'),count:$('C_count'),diag:$('C_diag'),info:$('C_info'),title:$('C_title'),venue:$('C_venue'),ident:$('C_ident'),favBtn:$('C_favBtn'),
  tracks:$('C_tracks'),trackList:$('C_trackList'),trackScroll:$('C_trackScroll'),placeholder:$('C_placeholder'),tracksLoad:$('C_tracksLoad')
};
  const FAVS=new Set(JSON.parse(localStorage.getItem('lma:concert-favs')||'[]'));
  const S={items:[],total:0,page:1,favOnly:false,current:null,tracks:[],idx:-1};
  const fmtDate=iso=>{const m=String(iso||'').match(/(\d{4})-(\d{2})-(\d{2})/);return m?`${m[2]}/${m[3]}/${m[1]}`:(iso||'')};
  const stars=r=>{const n=Math.round(parseFloat(r||0));return(isNaN(n)||n<=0)?'‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ':'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,n)+'‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(n)};
  const norm=s=>(s||'').toLowerCase().replace(/\s+/g,' ').replace(/[^\w\s>/:-]/g,'').trim();
  const parseNo=name=>{const m=/(?:^|[^a-z])t?(\d{1,2})(?:\D|$)/i.exec(name||'');return m?parseInt(m[1],10):null};
  const prefsKey=()=>`lma:prefs:${APP.collection}`; const savePrefs=()=>localStorage.setItem(prefsKey(),JSON.stringify({year:$el.year?.value,sort:$el.sort?.value,filter:$el.filter?.value}));
  const loadPrefs=()=>{try{return JSON.parse(localStorage.getItem(prefsKey())||'{}')}catch{return{}}};
  const BASE_Q=()=>`collection:${APP.collection} AND mediatype:(etree OR audio)`;

  async function fetchYears(){
    if(!$el.year) return;
    $el.year.innerHTML='<option>Loading years‚Ä¶</option>'; $el.year.disabled=true; if($el.count) $el.count.textContent='‚Äî';
    const url=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(BASE_Q())}&rows=0&page=1&output=json&fl[]=year&facets=year`;
    let map={}; try{const d=await jsonp(url); map=d?.response?.facets?.year||{}}catch{}
    if(!Object.keys(map).length){
      const base=`https://archive.org/advancedsearch.php?q=${encodeURIComponent(BASE_Q())}`, pages=3, batch=500, tmp={};
      for(let p=1;p<=pages;p++){
        if($el.yearProg) $el.yearProg.textContent=` scanning years‚Ä¶ ${p}/${pages}`;
        try{
          const r=await jsonp(`${base}&fl[]=year&rows=${batch}&page=${p}&output=json`);
          (r?.response?.docs||[]).forEach(doc=>{const y=String(doc.year||''); if(/^\d{4}$/.test(y)) tmp[y]=(tmp[y]||0)+1});
        }catch{break}
      }
      if($el.yearProg) $el.yearProg.textContent='';
      map=tmp;
    }
    const years=Object.keys(map).map(n=>+n).sort((a,b)=>a-b);
    $el.year.innerHTML='';
    const add=(l,v)=>{const o=new Option(l,v);o.style.background='#111';o.style.color='#fff';$el.year.appendChild(o)};
    add('All','all'); years.forEach(y=>add(`${y}${map[y]?` (${fmt(map[y])})`:''}`,String(y)));
    $el.year.disabled=false;
    const p=loadPrefs(); if(p.year && (p.year==='all'||[...$el.year.options].some(o=>o.value===p.year))) $el.year.value=p.year; else $el.year.value='all';
  }

  function buildQuery(){const y=$el.year?.value||'all'; return BASE_Q() + (y==='all'?'':` AND date:[${y}-01-01 TO ${y}-12-31]`)}

  async function fetchPage(reset){
    if(reset){S.items=[];S.page=1; if($el.list) $el.list.innerHTML='<div class="sub" style="padding:12px">Loading concerts‚Ä¶</div>';}
    const q=encodeURIComponent(buildQuery()); const [f,dir]=(($el.sort?.value)||'date asc').split(' '); const sort=encodeURIComponent(`${f} ${dir}`);
    const url=`https://archive.org/advancedsearch.php?q=${q}&fl[]=identifier,title,date,venue,coverage,year,avg_rating,num_reviews,downloads&sort[]=${sort}&rows=100&page=${S.page}&output=json`;
    try{const d=await jsonp(url); const docs=(d?.response?.docs)||[]; S.total=d?.response?.numFound||docs.length; S.items=S.items.concat(docs); S.page++; renderList();}
    catch{ if($el.list) $el.list.innerHTML='<div class="sub" style="padding:12px">Network blocked.</div>'; }
  }

  let filterTimer=null;
  function filtered(){
    const term=($el.filter?.value||'').toLowerCase().trim();
    let rows=S.items.slice(); if(S.favOnly) rows=rows.filter(x=>FAVS.has(x.identifier));
    if(term) rows=rows.filter(x=>(`${x.title||''} ${x.venue||''} ${x.coverage||''}`).toLowerCase().includes(term));
    return rows;
  }

  function renderList(){
    const rows=filtered(); const L=$el.list; if(!L) return; L.innerHTML='';
    if(!rows.length){L.innerHTML='<div class="sub" style="padding:12px">No concerts match.</div>'}
    rows.forEach(c=>{
      const rating=(c.avg_rating!=null)?parseFloat(c.avg_rating):null; const reviews=+c.num_reviews||0; const isFav=FAVS.has(c.identifier);
      const b=document.createElement('button'); b.className='row'; b.innerHTML=`
        <div class="title" title="${(c.title||'Untitled').replace(/"/g,'&quot;')}">${c.title||'Untitled'}</div>
        <div class="meta">${c.coverage||c.venue||''}</div>
        <div class="subrow">
          <span class="chip">${c.date?fmtDate(c.date):''}</span>
          ${c.downloads!=null?`<span class="chip" title="Views">${fmtCompact(c.downloads)}</span>`:''}
          <span class="spacer"></span>
          <span class="stars" title="${rating?`${rating.toFixed(1)} / 5 (${reviews})`:'No rating'}">${stars(rating)}</span>
          ${reviews?`<span class="chip" title="Reviews">${reviews}</span>`:''}
          <span class="fav ${isFav?'on':''}" title="${isFav?'Unmark favorite':'Mark favorite'}" aria-hidden="true">‚òÖ</span>
        </div>
        <div class="meta" style="opacity:.8">${c.identifier}</div>`;
      b.addEventListener('click',()=>openConcert(c)); L.appendChild(b);
    });
    if($el.count) $el.count.textContent=`${rows.length} / ${S.total} results`;
  }

  async function openById(id){
    S.current={identifier:id,title:id};
    if($el.info) $el.info.classList.remove('hidden'); if($el.tracks) $el.tracks.classList.add('hidden');
    if($el.tracksLoad) $el.tracksLoad.classList.remove('hidden'); if($el.placeholder) $el.placeholder.classList.add('hidden');
    try{
      const md=await jsonp(`https://archive.org/metadata/${encodeURIComponent(id)}`);
      const meta=md?.metadata||{};
      S.current.title=meta.title||id; S.current.venue=meta.coverage||meta.venue||'';
      if($el.title) $el.title.textContent=S.current.title;
      if($el.venue) $el.venue.textContent=S.current.venue||'';
      if($el.ident) $el.ident.textContent=id;
      renderFavBtn();
      await buildTracksFromMeta(md,id);
      APP.lastConcertId=id; APP.lastConcertTitle=S.current.title; saveCtx();
    }catch{
      if($el.diag) $el.diag.textContent='¬∑ failed to load concert';
      if($el.tracksLoad) $el.tracksLoad.classList.add('hidden');
    }
  }

  function renderFavBtn(){const onFav=!!(S.current&&FAVS.has(S.current.identifier)); if(!$el.favBtn) return; $el.favBtn.textContent=onFav?'‚òÖ':'‚òÜ'; $el.favBtn.title=onFav?'Unmark as favorite':'Mark as favorite'; $el.favBtn.setAttribute('aria-pressed',String(onFav))}
  on($el.favBtn,'click',()=>{ if(!S.current) return; const id=S.current.identifier; if(FAVS.has(id)) FAVS.delete(id); else FAVS.add(id); localStorage.setItem('lma:concert-favs',JSON.stringify([...FAVS])); renderFavBtn(); renderList(); });

  function chooseFiles(files,id){
    const byNo=new Map(), byTitle=new Map();
    for(const f of files){
      const no=(f.track&&/^\d+$/.test(String(f.track)))?parseInt(String(f.track),10):parseNo(f.name);
      const tit=f.title||f.track||(f.name||'').replace(/\.(mp3|ogg)$/i,''); const key=norm(tit);
      const prefer=(old,cur)=>!old?cur:(/\.mp3$/i.test(cur.name)?cur:old);
      if(no!=null) byNo.set(no,prefer(byNo.get(no),f)); else if(key) byTitle.set(key,prefer(byTitle.get(key),f));
    }
    const ordered=[...byNo.entries()].sort((a,b)=>a[0]-b[0]).map(e=>e[1]).concat(
      [...byTitle.values()].filter(f=>{const k=norm(f.title||f.track||f.name); return ![...byNo.values()].some(g=>norm(g.title||g.track||g.name)===k);})
    );
    return ordered.map((f,i)=>({i,name:(f.title||f.track||(f.name||'').replace(/\.(mp3|ogg)$/i,'')).trim(),url:`https://archive.org/download/${id}/${encodeURIComponent(f.name)}`,len:f.length||''}));
  }

  async function buildTracksFromMeta(md,id){
    const files=(md.files||[]).filter(f=>/\.mp3$|\.ogg$/i.test(f.name||'')); S.tracks=chooseFiles(files,id);
    renderTracks();
  }

  async function openConcert(c){
    APP.lastConcertId=c.identifier; APP.lastConcertTitle=c.title||'Untitled Concert'; saveCtx();
    S.current=c; S.tracks=[]; S.idx=-1;
    if($el.info) $el.info.classList.remove('hidden'); if($el.tracks) $el.tracks.classList.add('hidden');
    if($el.tracksLoad) $el.tracksLoad.classList.remove('hidden'); if($el.placeholder) $el.placeholder.classList.add('hidden');
    if($el.title) $el.title.textContent=c.title||'Untitled Concert'; if($el.venue) $el.venue.textContent=c.coverage||c.venue||''; if($el.ident) $el.ident.textContent=c.identifier||'';
    renderFavBtn(); setBrandColor(APP.collection);
    try{const data=await jsonp(`https://archive.org/metadata/${encodeURIComponent(c.identifier)}`); await buildTracksFromMeta(data,c.identifier);}
    catch{ if($el.diag) $el.diag.textContent='¬∑ failed to load metadata'; if($el.tracksLoad) $el.tracksLoad.classList.add('hidden');}
  }

  function renderTracks(){
    const L=$el.trackList; if(!L) return; L.innerHTML='';
    S.tracks.forEach((t,idx)=>{
      const r=document.createElement('div'); r.className='track';
      r.innerHTML=`<span class="tidx">${idx+1}</span>
                   <span class="tname">${t.name}<span class="eq" aria-hidden="true"><i></i><i></i><i></i></span></span>
                   <span class="ttime"><span class="tlen">${t.len||''}</span><span class="spinner" aria-hidden="true"></span></span>`;
      r.addEventListener('click',()=>playIdx(idx));
      L.appendChild(r);
    });
    if($el.tracksLoad) $el.tracksLoad.classList.add('hidden'); if($el.tracks) $el.tracks.classList.remove('hidden');
  }

  function freeze(fn){const c=$el.trackScroll; const st=c?c.scrollTop:0; fn(); if(c) c.scrollTop=st}
  function ensureVisible(i){const c=$el.trackScroll,child=$el.trackList?.children[i]; if(!c||!child) return; const top=child.offsetTop,bottom=top+child.offsetHeight,cTop=c.scrollTop,cBot=cTop+c.clientHeight; if(top<cTop)c.scrollTop=top-8; else if(bottom>cBot)c.scrollTop=bottom-c.clientHeight+8}
  function markLoading(on){const rows=[...($el.trackList?.children||[])]; freeze(()=>rows.forEach((n,ix)=>n.classList.toggle('loading',on&&ix===S.idx)))}
  function highlight(i){S.idx=i; const rows=[...($el.trackList?.children||[])]; freeze(()=>rows.forEach((n,ix)=>n.classList.toggle('on',ix===i))); requestAnimationFrame(()=>ensureVisible(i)); markLoading(false)}
  function playIdx(i){if(!S.tracks.length)return; highlight(i); PLAYER.load(S.tracks,i)}

  function bind(){
    on($el.year,'change',()=>{savePrefs();fetchPage(true)});
    on($el.sort,'change',()=>{savePrefs();fetchPage(true)});
    on($el.filter,'input',()=>{clearTimeout(filterTimer); filterTimer=setTimeout(()=>{savePrefs();renderList()},120)});
    on($el.favToggle,'click',()=>{const onp=$el.favToggle.getAttribute('aria-pressed')!=='true'; $el.favToggle.setAttribute('aria-pressed',String(onp)); S.favOnly=onp; renderList();});
    on($el.reset,'click',()=>{$el.year.value='all';$el.sort.value='date asc';$el.filter.value='';$el.favToggle.setAttribute('aria-pressed','false');S.favOnly=false;savePrefs();fetchPage(true)});
  }

  async function boot(){
    setBrandColor(APP.collection);
    try{
      const meta=await jsonp(`https://archive.org/metadata/${encodeURIComponent(APP.collection)}`);
      const pretty=meta?.metadata?.title||niceFromId(APP.collection);
      APP.collectionName=pretty; saveCtx();
      const h=$('hdr'); if(h) h.textContent=`Concert Browser ‚Äî ${pretty}`;
      const s=$('sub'); if(s) s.textContent=`Browsing ${pretty} ¬∑ change year/sort, filter, play tracks`;
      UI.updateHdrBandFav(pretty);
    }catch{
      const pretty=niceFromId(APP.collection); APP.collectionName=pretty; saveCtx();
      const h=$('hdr'); if(h) h.textContent=`Concert Browser ‚Äî ${pretty}`;
      const s=$('sub'); if(s) s.textContent=`Browse concerts ¬∑ change year/sort, filter, play tracks`;
      UI.updateHdrBandFav(pretty);
    }
    await fetchYears();
    const p=loadPrefs(); if(p.sort && $('C_sort')) $('C_sort').value=p.sort; if(p.filter && $('C_filter')) $('C_filter').value=p.filter;
    S.items=[]; S.page=1; await fetchPage(true); bind();
    if(APP.wantOpenIdentifier){ const id=APP.wantOpenIdentifier; APP.wantOpenIdentifier=''; await openById(id); if(PLAYER.state.idx>=0) highlight(PLAYER.state.idx); }
  }
  return{boot,highlight,markLoading,ensureVisible,openById};
})();

/* expose to player */
APP.markTrackLoading=(on)=>C.markLoading(on);
APP.ensureTrackVisible=(i)=>C.ensureVisible(i);
PLAYER.onChange(i=>{APP.lastTrackIdx=i; saveCtx(); C.highlight(i); UI.updateToast();});

/* ===== Bands ===== */
const BANDS=(()=>{const MAX_SHOW=100, FETCH_ROWS=1000;
  const el={sort:$('B_sort'), subj:$('B_subject'), q:$('B_q'), grid:$('B_grid'), count:$('B_count'), diag:$('B_diag'), fav:$('B_favToggle'), reset:$('B_reset')};
  const F=new Set(JSON.parse(localStorage.getItem('lma:collection-favs')||'[]'));
  const S={raw:[],filtered:[],favOnly:false,loaded:false};
  const saveFavs=()=>localStorage.setItem('lma:collection-favs',JSON.stringify([...F]));
  function toConcerts(id){ location.hash = '#/concerts?collection='+encodeURIComponent(id); }
  function filterSort(){
    const term=(el.q?.value||'').toLowerCase().trim(); const sub=el.subj?.value; const [field,dir]=(el.sort?.value||'downloads desc').split(' '); const asc=(dir||'asc').toLowerCase()==='asc';
    let rows=S.raw.slice(); if(S.favOnly) rows=rows.filter(r=>F.has(r.identifier));
    if(sub&&sub!=='*') rows=rows.filter(d=>{const arr=Array.isArray(d.subject)?d.subject:(d.subject?[d.subject]:[]); return arr.map(String).includes(sub)});
    if(term) rows=rows.filter(d=>(`${d.title||''} ${d.description||''}`).toLowerCase().includes(term));
    rows.sort((a,b)=>{let av=a[field], bv=b[field]; if(field==='downloads'){av=+av||0; bv=+bv||0}else{av=String(av||''); bv=String(bv||'')} return asc?(av>bv?1:av<bv?-1:0):(av<bv?1:av>bv?-1:0)});
    S.filtered=rows.slice(0,MAX_SHOW);
  }
  function render(){
    filterSort(); if(!el.grid) return; el.grid.innerHTML='';
    for(const d of S.filtered){
      const id=d.identifier, items=d.item_count ?? d.num_items, fv=F.has(id);
      const card=document.createElement('div'); card.className='bandCard';
      card.innerHTML=`
        <img class="thumb" alt="" loading="lazy" src="https://archive.org/services/img/${encodeURIComponent(id)}">
        <div class="bandTitle" title="${(d.title||id).replace(/"/g,'&quot;')}">${fv?'‚òÖ ':''}${d.title||id}</div>
        <div class="bandMeta">
          ${items!=null? `<span class="chip" title="Items">${fmt(items)} items</span>`:''}
          <span class="chip" title="Views">${fmtCompact(d.downloads)}</span>
        </div>
        <div class="favBand ${fv?'on':''}" title="${fv?'Unmark favorite':'Mark favorite'}">‚òÖ</div>
        <a class="cardLink" href="javascript:void(0)"></a>`;
      card.querySelector('.cardLink').addEventListener('click',()=>toConcerts(id));
      const star=card.querySelector('.favBand');
      star.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation(); if(F.has(id))F.delete(id); else F.add(id); saveFavs(); render();});
      el.grid.appendChild(card);
    }
    if(el.count) el.count.textContent=`${S.filtered.length} / ${S.raw.length} collections`;
  }
  function buildSubjects(docs){
    if(!el.subj) return; const counts=new Map();
    for(const d of docs){ const subs=Array.isArray(d.subject)?d.subject:(d.subject?[d.subject]:[]); for(const s of subs){const k=String(s).trim(); if(!k) continue; counts.set(k,(counts.get(k)||0)+1);} }
    const list=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,200);
    for(const [name,c] of list){const opt=new Option(`${name} (${c})`,name); opt.style.background='#111'; opt.style.color='#fff'; el.subj.appendChild(opt);}
  }
  async function load(){
    if(S.loaded) return; if(el.grid) el.grid.innerHTML='<div class="sub" style="padding:12px">Loading bands‚Ä¶</div>';
    const q=encodeURIComponent('collection:etree AND mediatype:collection');
    const fl=['identifier','title','description','subject','downloads','creator','item_count','num_items'];
    const url=`https://archive.org/advancedsearch.php?q=${q}&fl[]=${fl.join('&fl[]=')}&sort[]=downloads%20desc&rows=${FETCH_ROWS}&page=1&output=json`;
    try{ const data=await jsonp(url); S.raw=(data?.response?.docs)||[]; S.loaded=true; buildSubjects(S.raw); render(); if(el.diag) el.diag.textContent=''; }
    catch(e){ if(el.diag) el.diag.textContent='Network issue ‚Äî reload.' }
  }
  function bind(){ on(el.sort,'change',render); on(el.subj,'change',render); on(el.q,'input',render);
    on(el.fav,'click',()=>{S.favOnly=!S.favOnly; el.fav.setAttribute('aria-pressed',String(S.favOnly)); render();});
    on(el.reset,'click',()=>{if(el.sort) el.sort.value='downloads desc'; if(el.subj) el.subj.value='*'; if(el.q) el.q.value=''; S.favOnly=false; el.fav.setAttribute('aria-pressed','false'); render();});
  }
  function ensureLoaded(){ load(); }
  bind(); return {ensureLoaded, favStore:F};
})();

/* ===== Header band favorite + nav + toast ===== */
const UI=(()=>{
  const hdrFav=$('hdrBandFav'), nav=$('navBands');
  const toast=$('listenToast'), toastBtn=$('listenToastBtn'), toastClose=$('listenToastClose'), toastInfo=$('listenToastInfo');
  const F=BANDS.favStore;

  function updateHdrBandFav(prettyName){
    if(!hdrFav) return;
    if(!APP.collection){ hdrFav.classList.add('hidden'); return; }
    hdrFav.classList.remove('hidden');
    const id=APP.collection, on=F.has(id);
    hdrFav.textContent=on?'‚òÖ':'‚òÜ';
    hdrFav.setAttribute('aria-pressed',String(on));
    hdrFav.title=(on?'Unmark favorite band: ':'Mark favorite band: ')+ (prettyName||niceFromId(id));
  }
  on(hdrFav,'click',()=>{const id=APP.collection; if(!id) return; if(F.has(id)) F.delete(id); else F.add(id); localStorage.setItem('lma:collection-favs',JSON.stringify([...F])); updateHdrBandFav(APP.collectionName||niceFromId(id));});

  function updateNav(){
    if(!nav) return;
    if(APP.view==='concerts'){ nav.textContent='‚Ü©Ô∏é Bands'; nav.title='Back to bands'; nav.disabled=false; }
    else { nav.textContent='‚Ü™ Back to concert'; nav.title='Return to current concert'; nav.disabled = !APP.collection; }
  }
  on(nav,'click',()=>{
    if(APP.view==='concerts'){ location.hash='#/bands'; }
    else if(APP.collection){ APP.wantOpenIdentifier=APP.lastConcertId||''; location.hash='#/concerts?collection='+encodeURIComponent(APP.collection); }
  });

  function updateToast(){
    if(!toast) return;
    if(APP.view==='bands' && APP.collection && (APP.lastConcertId || APP.lastTrackIdx>=0)){
      const band = APP.collectionName || niceFromId(APP.collection);
      const what = `${band}${APP.lastConcertTitle?` ‚Ä¢ ${APP.lastConcertTitle}`:''}${APP.lastTrackIdx>=0?` ‚Ä¢ Track ${APP.lastTrackIdx+1}`:''}`;
      toastInfo.textContent = what;
      toast.classList.remove('hidden');
    }else{
      toast.classList.add('hidden');
    }
  }
  on(toastBtn,'click',()=>{ if(!APP.collection) return; APP.wantOpenIdentifier=APP.lastConcertId||''; location.hash='#/concerts?collection='+encodeURIComponent(APP.collection); });
  on(toastClose,'click',()=>{ if(toast) toast.classList.add('hidden'); });

  return {updateHdrBandFav, updateNav, updateToast};
})();

/* ===== Router (guards) ===== */
const ROUTER=(()=>{ function parseParams(hash){ return new URLSearchParams(hash.split('?')[1]||''); }
  function showBands(){
    APP.view='bands';
    const h=$('hdr'); if(h) h.textContent='Live Music Archive ‚Äî Bands';
    const s=$('sub'); if(s) s.textContent='Top collections ¬∑ tap a band to browse concerts';
    const vb=$('V_bands'); if(vb) vb.classList.remove('hidden');
    const vc=$('V_concerts'); if(vc) vc.classList.add('hidden');
    const favBtn=$('hdrBandFav'); if(favBtn) favBtn.classList.add('hidden');
    UI.updateNav(); UI.updateToast();
  }
  function showConcerts(){
    APP.view='concerts';
    const vb=$('V_bands'); if(vb) vb.classList.add('hidden');
    const vc=$('V_concerts'); if(vc) vc.classList.remove('hidden');
    UI.updateNav(); UI.updateToast();
  }
  async function route(){
    if(!location.hash){ location.replace('#/bands'); return; }
    if(location.hash.startsWith('#/bands')){ showBands(); BANDS.ensureLoaded(); }
    else if(location.hash.startsWith('#/concerts')){
      const p=parseParams(location.hash); const id=p.get('collection'); if(!id){ location.hash='#/bands'; return; }
      APP.collection=id; showConcerts(); await C.boot();
    } else { location.replace('#/bands'); }
  }
  addEventListener('hashchange',route);
  return {route};
})();

/* ===== Boot ===== */
addEventListener('resize',()=>WAVE.resize(),{passive:true});
PLAYER.onChange(i=>{/* highlight wired in C */});
ROUTER.route();
</script>
</body>
</html>


