<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Setlist Streamer</title>

<!-- PWA + Icons -->
<link rel="manifest" href="manifest.json?v=3">
<meta name="theme-color" content="#0f0f10">
<link rel="icon" href="icons/logo-32.png?v=3" sizes="32x32" type="image/png">
<link rel="icon" href="icons/logo-192.png?v=3" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="icons/logo-180.png?v=3" sizes="180x180">
<link rel="shortcut icon" href="icons/logo-32.png?v=3" type="image/png">

<link rel="preconnect" href="https://archive.org">

<style>
  :root{
    --bg:#0f0f10; --panel:#161719; --text:#e9e9ea; --muted:#a6a6ac; --accent:#5bd19a;
    --btn:#232428; --ring:#2b2d31; --warn:#ffd54a;
    --overlay: rgba(0,0,0,.45);
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit; text-decoration:none}

  .wrap{min-height:100%; display:flex; flex-direction:column}

  /* === HEADER (two-line layout with 3 zones) === */
  header{
    padding:8px 12px;
    background:var(--panel);
    position:sticky; top:0; z-index:6; /* above menu */
    box-shadow:0 1px 0 #000 inset, 0 1px 0 rgba(255,255,255,.03);
    display:flex; flex-direction:column; gap:4px;
  }
  .headerTop{
    display:grid;
    grid-template-columns: 42px 1fr 1fr; /* left, center, right (right can size to content) */
    align-items:center; column-gap:8px;
  }
  .headerLeft{display:flex; align-items:center; justify-content:flex-start}
  .headerCenter{
    text-align:center; font-size:16px; font-weight:700;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .headerRight{display:flex; align-items:center; justify-content:flex-end; gap:8px}
  .headerBottom{
    text-align:center; font-size:15px; font-weight:600; color:var(--warn);
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    display:flex; align-items:center; justify-content:center; gap:10px;
    min-height:22px; /* keeps layout steady when empty */
  }

  .hambtn{
    width:42px; height:42px; border-radius:12px;
    background:var(--btn); border:1px solid var(--ring);
    display:flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .hambtn span{display:block; width:18px; height:2px; background:#d7d7da; position:relative}
  .hambtn span::before,.hambtn span::after{
    content:""; position:absolute; left:0; width:18px; height:2px; background:#d7d7da;
  }
  .hambtn span::before{top:-6px}
  .hambtn span::after{top:6px}

  .headerActions .btn{min-height:32px; min-width:32px; padding:6px 10px; border-radius:10px}
  .btn{background:var(--btn); color:var(--text); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; justify-content:center; gap:6px; min-width:40px; min-height:40px; cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent}
  .muted{color:var(--muted)}
  .pillBtn{background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; color:var(--text)}

  /* Small star next to band name — yellow */
  .starInline{
    background:transparent; border:1px solid var(--ring);
    padding:2px 8px; border-radius:999px; line-height:1; cursor:pointer;
    color:var(--warn);
    font-size:16px;
  }

  /* Toolbars */
  .toolbar{display:flex; gap:8px; padding:10px 12px; align-items:center; flex-wrap:wrap}
  .pill{background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:8px 12px; display:flex; align-items:center; gap:8px}
  select, input[type="search"]{background:transparent; color:var(--text); border:none; outline:none; font:14px system-ui; min-width:120px}
  .chip{background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}

  /* Custom dropdowns */
  .dropdown{position:relative; min-width:150px; cursor:pointer}
  .dropBtn{background:transparent; border:none; color:var(--text); font:14px; width:100%; text-align:left; padding:0; pointer-events:none}
  .menu{
    position:absolute; top:110%; left:0; right:0;
    background:var(--panel); border:1px solid var(--ring); border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.45);
    display:none; max-height:280px; overflow:auto; z-index:50;
  }
  .menu.open{display:block}
  .menu .item{padding:9px 12px; cursor:pointer; white-space:nowrap}
  .menu .item:hover{background:#202124}

  /* Bands grid */
  .bandsGrid{display:grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap:8px; padding:0 12px 120px}
  .bandTile{background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:6px; display:flex; flex-direction:column; gap:6px; cursor:pointer}
  .bandTile img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; background:#0c0c0d}
  .bandTitle{font-weight:600; font-size:12px}
  .bandViews{font-size:10px; color:var(--muted)}

  /* Concert list */
  .grid{display:grid; grid-template-columns:1fr; gap:8px; padding:0 12px 120px}
  .card{background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:12px; display:flex; justify-content:space-between; align-items:center}
  .card.tap{cursor:pointer}
  .card h3{margin:0 0 6px 0; font-size:15px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .small{font-size:12px; color:var(--muted)}
  .favToggle{min-width:40px}
  .loadMore{justify-content:center}

  /* Track list */
  .tracks{display:grid; gap:6px; padding:0 12px 120px}
  .track{position:relative; background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px}
  .tleft{display:flex; gap:10px; align-items:center}
  .tnum{width:18px; text-align:right; color:var(--muted); font-size:12px}
  .tname{font-size:14px}
  .tlen{font-size:12px; color:var(--muted)}
  .track.playing{box-shadow:0 0 0 2px rgba(255,213,74,.25) inset}
  .track.playing::before{content:""; position:absolute; left:0; top:0; bottom:0; width:6px; background:var(--warn); border-radius:12px 0 0 12px}
  .progressBar{position:absolute; left:0; bottom:0; height:3px; background:var(--warn); border-radius:0 0 12px 12px; width:0%}

  /* Show header meta */
  .showMeta{display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding:6px 12px 8px}
  .showTitle{font-weight:600; margin-right:6px}
  .showMeta .end{margin-left:auto; display:flex; align-items:center}
  .stars{display:inline-flex; align-items:center; gap:4px}

  /* === FIXED PLAYER === */
  .player{
    position:fixed; left:0; right:0; bottom:0;
    background:var(--panel);
    border-top:1px solid var(--ring);
    box-shadow:0 -1px 0 #000 inset, 0 -6px 24px rgba(0,0,0,.35);
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    z-index:5;
  }
  .player .controls{
    display:flex; align-items:center; gap:8px;
    max-width:1000px; margin:0 auto;
  }
  #P_seek{flex:1; height:6px; border:none; outline:none; border-radius:999px; background:#2a2b2f; -webkit-appearance:none; appearance:none;}
  #P_seek::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:#7bdcaa; border:none;}
  #P_seek::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:#7bdcaa; border:none; }

  .eqBtn{ width:42px; height:42px; border-radius:12px; border:1px solid var(--ring); background:var(--btn); display:flex; align-items:center; justify-content:center; cursor:pointer }
  .eqBars{ display:inline-flex; align-items:flex-end; gap:3px; width:18px; height:16px }
  .eqBars span{ width:4px; background:#7bdcaa; border-radius:2px; animation:eq 1.1s infinite ease-in-out; transform-origin:bottom }
  .eqBars span:nth-child(1){ animation-delay:0s }
  .eqBars span:nth-child(2){ animation-delay:.15s }
  .eqBars span:nth-child(3){ animation-delay:.3s }
  @keyframes eq { 0%,100%{height:20%} 25%{height:80%} 50%{height:40%} 75%{height:70%} }
  .eqBars.paused span{ animation-play-state: paused; opacity:.6; }

  .volWrap{position:relative}
  .volPop{
    position:fixed; left:50%; transform:translateX(-50%); bottom:72px;
    background:var(--panel); border:1px solid var(--ring); border-radius:12px;
    padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.45); display:none;
    width:260px; max-width:90vw; z-index:40;
  }
  .volPop.open{display:block}
  .volRow{display:flex; align-items:center; gap:10px}

  /* === LEFT SLIDE-OUT MENU === */
  .overlay{
    position:fixed; inset:0; background:var(--overlay); display:none; z-index:7;
  }
  .overlay.open{display:block}
  .sideMenu{
    position:fixed; top:0; bottom:0; left:0; width:260px; max-width:86vw;
    background:var(--panel); border-right:1px solid var(--ring);
    box-shadow:0 8px 32px rgba(0,0,0,.4);
    transform:translateX(-105%); transition:transform .22s ease-out;
    z-index:8; display:flex; flex-direction:column;
  }
  .sideMenu.open{ transform:translateX(0); }
  .sideHeader{padding:14px 12px; font-weight:700; border-bottom:1px solid var(--ring)}
  .menuList{padding:8px 8px 14px; display:grid; gap:6px; overflow:auto}
  .menuItem{padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:var(--btn); cursor:pointer}
  .menuItem:hover{background:#2a2b2f}
</style>
</head>
<body>
<div class="wrap">
  <!-- Overlay + Side Menu -->
  <div id="menuOverlay" class="overlay" aria-hidden="true"></div>
  <nav id="sideMenu" class="sideMenu" aria-label="Main">
    <div class="sideHeader">Menu</div>
    <div class="menuList">
      <div class="menuItem">Discover</div>
      <div class="menuItem">My Favorites</div>
      <div class="menuItem">Recent Shows</div>
      <div class="menuItem">Random Concert</div>
      <div class="menuItem">Settings</div>
      <div class="menuItem">About</div>
    </div>
  </nav>

  <header>
    <div class="headerTop">
      <!-- LEFT: Hamburger -->
      <div class="headerLeft">
        <button id="hamburger" class="hambtn" aria-label="Open menu"><span></span></button>
      </div>

      <!-- CENTER: Route Title (Bands / Concerts / Tracks) -->
      <div id="routeTitle" class="headerCenter">Setlist Streamer — Bands</div>

      <!-- RIGHT: Back buttons (dynamic) -->
      <div id="headerActions" class="headerRight"></div>
    </div>

    <!-- SECOND ROW: Band name (only on Concerts page) -->
    <div id="headerBandName" class="headerBottom"></div>
  </header>

  <!-- Bands toolbar -->
  <div class="toolbar" id="toolbar-bands">
    <div class="pill"><select id="sortSel" aria-label="Sort">
      <option value="downloads desc" selected>Views ↓</option>
      <option value="downloads asc">Views ↑</option>
      <option value="title asc">Title A→Z</option>
      <option value="title desc">Title Z→A</option>
    </select></div>
    <div class="pill"><select id="subjectSel" aria-label="Subject">
      <option value="all" selected>All subjects</option>
    </select></div>
    <div class="pill" style="flex:1 1 160px;"><input id="searchBox" type="search" placeholder="e.g., Grateful Dead, bluegrass" style="width:100%"></div>
    <button id="favToggle" class="btn">☆ Favorites</button>
    <button id="resetBtn" class="btn ghost muted">Reset</button>
  </div>

  <!-- Concerts toolbar -->
  <div class="toolbar" id="toolbar-band" style="display:none;">
    <div class="pill dropdown" id="sortDrop" aria-label="Sort">
      <button class="dropBtn" id="sortBtn">Sort</button>
      <div class="menu" id="sortMenu" role="listbox" aria-label="Sort options">
        <div class="item" data-value="auto">Auto</div>
        <div class="item" data-value="date asc">Date ↑</div>
        <div class="item" data-value="date desc">Date ↓</div>
        <div class="item" data-value="avg_rating desc">Reviews ↓</div>
        <div class="item" data-value="downloads desc">Views ↓</div>
      </div>
    </div>

    <div class="pill dropdown" id="yearDrop" aria-label="Year">
      <button class="dropBtn" id="yearBtn">All years</button>
      <div class="menu" id="yearMenu" role="listbox" aria-label="Year options">
        <div class="item muted">Loading years…</div>
      </div>
    </div>

    <div class="pill" style="flex:1 1 160px;"><input id="concertSearch" type="search" placeholder="Filter (venue/city/title)" style="width:100%"></div>

    <button id="favConcertsToggle" class="btn" title="Show only favorites">☆ Favorites</button>
    <button id="resetConcerts" class="btn ghost muted">Reset</button>
  </div>

  <!-- Show header metadata -->
  <div id="showMeta" class="showMeta" style="display:none;">
    <span class="showTitle" id="showTitle"></span>
    <span class="chip" id="showDate" style="display:none;"></span>
    <span class="chip" id="showLoc"  style="display:none;"></span>
    <div class="end">
      <button class="pillBtn" id="favShowBtn" title="Favorite">☆ Favorite</button>
    </div>
  </div>

  <div id="content" class="grid" aria-live="polite"></div>
</div>

<!-- Fixed Player -->
<div class="player" id="player">
  <div class="controls">
    <button id="P_now" class="eqBtn" title="Go to currently playing">
      <span class="eqBars" aria-hidden="true"><span style="height:60%"></span><span style="height:30%"></span><span style="height:45%"></span></span>
    </button>
    <button id="P_prev" class="btn" title="Previous">⏮</button>
    <button id="P_play" class="btn" title="Play/Pause">▶️</button>
    <button id="P_next" class="btn" title="Next">⏭</button>

    <div class="seekWrap" style="display:flex; align-items:center; gap:10px; flex:1; min-width:180px">
      <div id="P_times" style="font-size:12px; color:var(--muted); white-space:nowrap"><span class="cur">0:00</span><span class="dur"> / 0:00</span></div>
      <input id="P_seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
    </div>

    <div class="volWrap">
      <button id="P_mute" class="btn" title="Volume">🔈</button>
      <div id="volPop" class="volPop" role="dialog" aria-label="Volume">
        <div class="volRow">
          <span class="small" style="min-width:36px">Vol</span>
          <input id="P_vol" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume">
          <span id="volLabel" class="small" style="min-width:32px;text-align:right">100%</span>
        </div>
      </div>
    </div>
  </div>
  <audio id="audio" crossorigin="anonymous"></audio>
</div>

<script>
/* ------------ utils/store ------------ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = secs => { secs = Math.max(0, Math.floor(secs||0)); const m=Math.floor(secs/60), s=secs%60; return m+":"+String(s).padStart(2,"0"); };
const fmtCompact = n => { n=Number(n||0); if(n>=1e9) return (n/1e9).toFixed(1)+'B'; if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return String(n); };
function show(el,on=true){ if(!el) return; el.style.display=on?'':'none'; }
const store = { get(k,f){ try{return JSON.parse(localStorage.getItem(k))??f;}catch{return f;}}, set(k,v){ localStorage.setItem(k,JSON.stringify(v)); } };

/* Pretty band name from identifier when we don't have the title */
function prettyBandName(id=''){
  return String(id)
    .replace(/[_-]+/g,' ')
    .replace(/([a-z])([A-Z])/g,'$1 $2')
    .replace(/\s+/g,' ')
    .trim();
}

/* ------------ router ------------ */
const Router = (() => {
  const routes={};
  function on(n,f){routes[n]=f}
  function parse(){ const raw=location.hash.replace(/^#\/?/,''); const [name,...rest]=raw.split('/').filter(Boolean); return {name:name||'bands', params:rest}; }
  function route(){
    const r=parse();
    (routes[r.name]||routes['bands'])(r.params);
    updateHeaderForRoute(r.name);
  }
  return {on,route};
})();
addEventListener('hashchange', Router.route); addEventListener('DOMContentLoaded', Router.route);

/* ------------ Left Menu (hamburger) ------------ */
const sideMenu = $('#sideMenu');
const menuOverlay = $('#menuOverlay');
const hamburger = $('#hamburger');

function openMenu(){ sideMenu.classList.add('open'); menuOverlay.classList.add('open'); }
function closeMenu(){ sideMenu.classList.remove('open'); menuOverlay.classList.remove('open'); }
hamburger.addEventListener('click', openMenu);
menuOverlay.addEventListener('click', closeMenu);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); }});

/* ------------ robust fetch ------------ */
async function fetchWithTimeout(url, {timeout=12000}={}){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const res = await fetch(url, {cache:'no-store', signal: ctrl.signal});
    clearTimeout(id);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res;
  }catch(e){ clearTimeout(id); throw e; }
}
async function fetchJSON(url){ const r = await fetchWithTimeout(url); return r.json(); }

/* ------------ JSONP helper (silent fallback) ------------ */
function fetchJSONP(url, {timeout=12000}={}){
  return new Promise((resolve)=>{
    const cb = '__iajsonp_'+Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    const t = setTimeout(()=>{ cleanup(); resolve(null); }, timeout);
    function cleanup(){ clearTimeout(t); delete window[cb]; s.remove(); }
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror = ()=>{ cleanup(); resolve(null); };
    document.head.appendChild(s);
  });
}

/* ------------ IA helpers ------------ */
const IA = {
  bandsUrl({ q='collection:(etree) AND mediatype:(collection)', sort='downloads desc', rows=120 }={}){
    const u=new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q',q);
    ['identifier','title','downloads'].forEach(f=>u.searchParams.append('fl[]',f));
    u.searchParams.append('sort[]',sort); u.searchParams.set('rows',rows); u.searchParams.set('page',1); u.searchParams.set('output','json'); return u.toString();
  },
  concertsUrl({ bandId, sort='date desc', rows=200, page=1, year='', term='' }){
    let q=`collection:(${bandId}) AND mediatype:(etree OR audio)`; if(year) q+=` AND year:(${year})`;
    if(term) q+=` AND (title:(${term}) OR date:(${term}) OR venue:(${term}) OR coverage:(${term}))`;
    const u=new URL('https://archive.org/advancedsearch.php'); u.searchParams.set('q',q);
    ['identifier','title','date','year','downloads','avg_rating','num_reviews','venue','coverage','creator','publicdate'].forEach(f=>u.searchParams.append('fl[]',f));
    u.searchParams.append('sort[]',sort); u.searchParams.set('rows',rows); u.searchParams.set('page',page); u.searchParams.set('output','json'); return u.toString();
  },
  yearsOnlyUrl({ bandId, rows=1200, page=1 }){
    const u=new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q',`collection:(${bandId}) AND mediatype:(etree OR audio)`);
    u.searchParams.append('fl[]','year');
    u.searchParams.set('rows',rows);
    u.searchParams.set('page',page);
    u.searchParams.set('output','json');
    u.searchParams.append('sort[]','date asc');
    return u.toString();
  },
  facetYearsJSONP({ bandId }){
    const u=new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q',`collection:(${bandId}) AND mediatype:(etree OR audio)`);
    u.searchParams.set('rows','0'); u.searchParams.set('output','json');
    u.searchParams.append('facet[]','year'); u.searchParams.set('facet_limit','10000'); u.searchParams.set('facet_mincount','1');
    return fetchJSONP(u.toString(), {timeout:12000});
  },
  metaUrl:id=>`https://archive.org/metadata/${id}`,
  imgUrl:id=>`https://archive.org/services/img/${id}`
};

/* ------------ retry card ------------ */
function showRetry(contentEl, message, retryFn){
  contentEl.className='grid';
  contentEl.innerHTML = `
    <div class="card">
      <div class="retryWrap">
        <span class="small">${message}</span>
        <button class="btn" id="retryBtn">Retry</button>
      </div>
    </div>`;
  $('#retryBtn')?.addEventListener('click', retryFn);
}

/* ------------ SVG stars (full/half/empty) ------------ */
let _starUid = 0;
function starSVG(type){
  const id = 'g'+(++_starUid);
  if(type==='full'){
    return `<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
      <path d="M12 2.3l2.9 5.9 6.6 1-4.8 4.7 1.1 6.6L12 17.8 6.2 20.5 7.3 13.9 2.5 9.2l6.6-1z" fill="#ffcc33" stroke="#ffcc33" stroke-width="1"/>
    </svg>`;
  }
  if(type==='half'){
    return `<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
      <defs>
        <linearGradient id="${id}" x1="0" x2="1" y1="0" y2="0">
          <stop offset="50%" stop-color="#ffcc33"/>
          <stop offset="50%" stop-color="transparent"/>
        </linearGradient>
      </defs>
      <path d="M12 2.3l2.9 5.9 6.6 1-4.8 4.7 1.1 6.6L12 17.8 6.2 20.5 7.3 13.9 2.5 9.2l6.6-1z" fill="url(#${id})" stroke="#ffcc33" stroke-width="1"/>
    </svg>`;
  }
  return `<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
    <path d="M12 2.3l2.9 5.9 6.6 1-4.8 4.7 1.1 6.6L12 17.8 6.2 20.5 7.3 13.9 2.5 9.2l6.6-1z" fill="none" stroke="#ffcc33" stroke-width="1"/>
  </svg>`;
}
function renderStars(r){
  const rating = Math.round((r||0)*2)/2;
  let out = '';
  for(let i=1;i<=5;i++){
    out += rating>=i ? starSVG('full') : (rating>=i-0.5 ? starSVG('half') : starSVG('empty'));
  }
  return `<span class="stars" aria-label="${rating} out of 5 stars">${out}</span>`;
}

/* ------------ Favorites (bands & shows) ------------ */
function favBands(){ return store.get('favBands',[]); }
function isBandFav(id){ return favBands().includes(id); }
function toggleBandFav(id){
  const arr = favBands();
  const i = arr.indexOf(id);
  if(i>=0) arr.splice(i,1); else arr.push(id);
  store.set('favBands', arr);
  updateBandFavUI();
}
function updateBandFavUI(){
  const btn=$('#bandFavBtn');
  if(!btn) return;
  const on = isBandFav(currentBandId);
  btn.textContent = on ? '★' : '☆';
  btn.title = on ? 'Unfavorite band' : 'Favorite band';
}

/* ------------ Bands page state ------------ */
let currentBandId='';
let state={year:'', term:'', sortSel:'auto', page:1, numFound:0, rows:200, list:[]};
let onlyFavConcerts=false;
let onlyFavBands=false;

function favShows(){ return store.get('favShows',[]); }
function isFav(id){ return favShows().includes(id); }

/* ------------ Header controller ------------ */
function updateHeaderForRoute(routeName){
  const titleEl = $('#routeTitle');
  const actions = $('#headerActions');
  const bandNameEl = $('#headerBandName');

  // Center title per page
  if(routeName==='band') titleEl.textContent = 'Setlist Streamer — Concerts';
  else if(routeName==='show') titleEl.textContent = 'Setlist Streamer — Tracks';
  else titleEl.textContent = 'Setlist Streamer — Bands';

  // Right-side actions (back buttons)
  actions.innerHTML = '';
  if(routeName==='band'){
    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.title = 'Back';
    btn.textContent = '← Bands';
    btn.onclick = () => { location.hash = '#/bands'; };
    actions.appendChild(btn);
  }
  if(routeName==='show'){
    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.title = 'Back';
    btn.textContent = '← Concerts';
    btn.onclick = () => history.back();
    actions.appendChild(btn);
  }

  // Second row — only for Concerts page; others clear.
  if(routeName!=='band') bandNameEl.textContent = '';
}

/* ------------ Bands page ------------ */
async function showBands(){
  show($('#toolbar-bands'),true); show($('#toolbar-band'),false); show($('#showMeta'),false);

  const content=$('#content'); content.className='bandsGrid'; content.innerHTML=`<div class="card"><span class="small">Loading bands…</span></div>`;
  const sort=$('#sortSel')?.value||'downloads desc'; const term=($('#searchBox')?.value||'').trim();
  let q='collection:(etree) AND mediatype:(collection)'; if(term) q+=` AND (title:(${term}) OR identifier:(${term}))`;

  const favBtn = $('#favToggle');
  if (favBtn && !favBtn._wired){
    favBtn._wired = true;
    favBtn.addEventListener('click', ()=>{
      onlyFavBands = !onlyFavBands;
      favBtn.textContent = onlyFavBands ? '★ Favorites' : '☆ Favorites';
      showBands();
    });
  }

  const load = async ()=>{
    try{
      const data=await fetchJSON(IA.bandsUrl({q,sort,rows:120}));
      let items=(data?.response?.docs||[]).map(d=>({id:d.identifier,title:d.title||d.identifier,downloads:d.downloads||0}));
      if (onlyFavBands){
        const f = new Set(favBands());
        items = items.filter(b=>f.has(b.id));
      }
      if (!items.length){
        content.innerHTML = `<div class="card"><span class="small">${onlyFavBands?'No favorite bands yet. Open a band and star it.':'No bands found.'}</span></div>`;
        return;
      }
      content.innerHTML = items.map(b=>`
        <div class="bandTile" data-id="${b.id}" data-title="${(b.title||'').replace(/"/g,'&quot;')}">
          <img src="${IA.imgUrl(b.id)}" alt="${b.title}">
          <div class="bandTitle">${b.title}</div>
          <div class="bandViews">${b.downloads.toLocaleString()} views</div>
        </div>`).join('');
      content.onclick = ev => {
        const tile=ev.target.closest('.bandTile'); if(!tile) return;
        const id = tile.dataset.id; const title = tile.dataset.title;
        if(id && title) store.set('bandTitle_'+id, title);
        location.hash='#/band/'+encodeURIComponent(id);
      };
    }catch(e){
      const msg = navigator.onLine ? 'Network error while loading bands.' : 'You appear to be offline.';
      showRetry(content, msg, load);
    }
  };
  load();
}

/* ------------ Concerts page ------------ */
function resolveSort(){ return state.sortSel==='auto' ? (state.year ? 'date asc' : 'date desc') : state.sortSel; }

async function buildYearCounts(bandId){
  const facet = await IA.facetYearsJSONP({bandId});
  let counts = {};
  if (facet?.response?.facets?.year){
    const y = facet.response.facets.year;
    for(const k in y){ if(!isNaN(+k)) counts[k] = y[k]; }
  }
  if (!Object.keys(counts).length){
    let page=1, rows=1200, numFound=Infinity, got=0;
    while(got < numFound && page<=120){
      const data = await fetchJSON(IA.yearsOnlyUrl({bandId, rows, page}));
      const resp = data?.response || {};
      numFound = Number(resp.numFound || 0);
      const docs = resp.docs || [];
      for(const d of docs){
        const yv = Array.isArray(d.year) ? d.year[0] : d.year;
        if(yv) counts[yv] = (counts[yv]||0)+1;
      }
      got += docs.length; page++;
      if(page % 2 === 0) updateYearMenu(counts);
    }
  }
  updateYearMenu(counts);
  const yearsArr = Object.keys(counts).map(y=>({year:Number(y), count:counts[y]})).filter(o=>!isNaN(o.year)).sort((a,b)=>a.year-b.year);
  store.set('years_'+bandId, {ts: Date.now(), years: yearsArr});
}
function updateYearMenu(counts){
  const yearsArr = Object.keys(counts).map(y=>({year:Number(y), count:counts[y]})).filter(o=>!isNaN(o.year)).sort((a,b)=>a.year-b.year);
  if(yearsArr.length){
    YearDrop.setOptions([{value:'', label:'All years'}, ...yearsArr.map(o=>({value:String(o.year), label:`${o.year} (${o.count.toLocaleString()})`}))]);
    YearDrop.setValue(YearDrop.getValue());
  }
}

const SortDrop = (()=> {
  const wrap = document.getElementById('sortDrop');
  const btn  = document.getElementById('sortBtn');
  const menu = document.getElementById('sortMenu');
  let value = 'auto';
  const options = [
    {value:'auto', label:'Auto'},
    {value:'date asc', label:'Date ↑'},
    {value:'date desc', label:'Date ↓'},
    {value:'avg_rating desc', label:'Reviews ↓'},
    {value:'downloads desc', label:'Views ↓'},
  ];
  function render(){ menu.innerHTML = options.map(o=>`<div class="item" data-value="${o.value}">${o.label}</div>`).join(''); }
  function close(){ menu.classList.remove('open'); }
  wrap.addEventListener('click', (e)=>{ if(e.target.closest('.item')) return; menu.classList.toggle('open'); });
  document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) close(); });
  menu.addEventListener('click', (e)=>{
    const it = e.target.closest('.item'); if(!it) return;
    setValue(it.dataset.value, false);
    close();
    onChange?.(value);
  });
  function setValue(v, placeholder=false){
    value = v||'auto';
    btn.textContent = placeholder && value==='auto' ? 'Sort'
      : (options.find(o=>o.value===value)?.label || 'Sort');
  }
  let onChange = null;
  function subscribe(fn){ onChange = fn; }
  render(); setValue('auto', true);
  return {getValue:()=>value, setValue, subscribe};
})();

const YearDrop = (()=> {
  const wrap = document.getElementById('yearDrop');
  const btn  = document.getElementById('yearBtn');
  const menu = document.getElementById('yearMenu');
  let value = '';
  let options = [{value:'', label:'All years'}];
  function render(){ menu.innerHTML = options.map(o=>`<div class="item" data-value="${o.value}">${o.label}</div>`).join(''); }
  function close(){ menu.classList.remove('open'); }
  wrap.addEventListener('click', (e)=>{ if(e.target.closest('.item')) return; menu.classList.toggle('open'); });
  document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) close(); });
  menu.addEventListener('click', (e)=>{
    const it = e.target.closest('.item'); if(!it) return;
    value = it.dataset.value || '';
    btn.textContent = (options.find(o=>String(o.value)===String(value))?.label) || 'All years';
    close();
    resetAndLoad({year:value});
  });
  function setOptions(arr){ options = arr; render(); }
  function setValue(v){ value=v||''; btn.textContent=(options.find(o=>String(o.value)===String(value))?.label)||'All years'; }
  function getValue(){ return value; }
  render();
  return {setOptions,setValue,getValue};
})();

async function loadPage(){
  const content=$('#content');
  const sortExpr = resolveSort();
  const url = IA.concertsUrl({bandId:currentBandId, sort:sortExpr, rows:state.rows, page:state.page, year:state.year, term:state.term});
  try{
    const data = await fetchJSON(url);
    const resp = data?.response || {};
    state.numFound = Number(resp.numFound || 0);
    state.list = state.list.concat(resp.docs || []);
    renderConcerts();
  }catch(e){
    showRetry(content, 'Network error while loading concerts.', ()=>loadPage());
  }
}

function resetAndLoad(patch={}){
  state = { ...state, ...patch, page:1, list:[], numFound:0 };
  const content=$('#content'); content.className='grid'; content.innerHTML=`<div class="card"><span class="small">Loading concerts…</span></div>`;
  loadPage();
}

async function showBand(params){
  show($('#toolbar-bands'),false); show($('#toolbar-band'),true); show($('#showMeta'),false);
  currentBandId = decodeURIComponent((params||[])[0]||'');

  SortDrop.subscribe((val)=> resetAndLoad({sortSel:val}));
  SortDrop.setValue('auto', true);

  $('#favConcertsToggle').onclick=()=>{ onlyFavConcerts=!onlyFavConcerts; renderConcerts(); $('#favConcertsToggle').textContent = onlyFavConcerts?'★ Favorites':'☆ Favorites'; };
  $('#resetConcerts').onclick=()=>{ onlyFavConcerts=false; YearDrop.setValue(''); $('#concertSearch').value=''; SortDrop.setValue('auto', true); $('#favConcertsToggle').textContent='☆ Favorites'; resetAndLoad({year:'', term:'', sortSel:'auto'}); };
  $('#concertSearch').onchange=()=> resetAndLoad({term:($('#concertSearch').value||'').trim().toLowerCase()});

  const cached = store.get('years_'+currentBandId,null);
  if(cached){ const counts={}; for(const y of cached.years) counts[y.year]=y.count; updateYearMenu(counts); }
  else { YearDrop.setOptions([{value:'', label:'All years'}, {value:'', label:'Loading years…'}]); }
  buildYearCounts(currentBandId).catch(()=>{});

  const storedTitle = store.get('bandTitle_'+currentBandId, null);
  const label = storedTitle || prettyBandName(currentBandId||'');
  const bandHeader = $('#headerBandName');
  bandHeader.innerHTML = `<span id="headerBandLabel">${label}</span><button id="bandFavBtn" class="starInline" title="Favorite band">☆</button>`;
  $('#bandFavBtn').addEventListener('click', ()=> toggleBandFav(currentBandId));
  updateBandFavUI();

  resetAndLoad({year:'', term:'', sortSel:'auto'});
}

function renderConcerts(){
  const content=$('#content'); if(!content) return;
  let list=state.list.slice();
  if(onlyFavConcerts){ const fav=favShows(); list=list.filter(d=>fav.includes(d.identifier)); }

  if(!list.length){ content.innerHTML=`<div class="card"><span class="small">No concerts found.</span></div>`; return; }

  content.innerHTML = list.map(it=>{
    const dateStr = it.date ? new Date(it.date).toLocaleDateString() : (it.year||'');
    const reviews = it.num_reviews||0;
    const venueLine = [it.venue, it.coverage].filter(Boolean).join(', ');
    const viewsChip = `<span class="chip">${fmtCompact(it.downloads||0)} views</span>`;
    return `
      <div class="card tap" data-id="${it.identifier}">
        <div>
          <h3>${it.title || it.identifier}</h3>
          <div class="row">
            <span class="chip">${dateStr}</span>
            ${viewsChip}
            ${renderStars(it.avg_rating||0)} <span class="small">(${reviews})</span>
          </div>
          <div class="small">${venueLine}</div>
        </div>
        <div class="row">
          <button class="btn ghost favToggle" title="Favorite">${isFav(it.identifier)?'★':'☆'}</button>
        </div>
      </div>`;
  }).join('');

  if(!onlyFavConcerts && state.list.length < state.numFound){
    const more = document.createElement('div');
    more.className='card loadMore';
    more.innerHTML = `<button class="btn" id="loadMoreBtn">Load more (${state.list.length} / ${state.numFound})</button>`;
    content.appendChild(more);
    $('#loadMoreBtn').onclick = ()=>{ state.page += 1; loadPage(); };
  }

  content.onclick = ev => {
    const favBtn = ev.target.closest('.favToggle');
    if (favBtn){
      const card = favBtn.closest('.card'); const id = card.dataset.id;
      const fav=favShows(); const i=fav.indexOf(id); if(i>=0) fav.splice(i,1); else fav.push(id);
      store.set('favShows',fav); renderConcerts();
      return;
    }
    const card = ev.target.closest('.card.tap');
    if (card) location.hash = '#/show/' + encodeURIComponent(card.dataset.id);
  };
}

/* ------------ Show (tracks) ------------ */
let currentShowId=''; let currentShowTitle=''; let trackEls=[]; let trackList=[];

function toggleFav(id){ const fav=favShows(); const i=fav.indexOf(id); if(i>=0) fav.splice(i,1); else fav.push(id); store.set('favShows',fav); updateFavBtn(); }
function updateFavBtn(){ const btn=$('#favShowBtn'); if(!btn) return; btn.textContent = favShows().includes(currentShowId)?'★ Favorited':'☆ Favorite'; }
function setShowHeader(meta){
  const title = meta?.metadata?.title || currentShowId;
  const date  = meta?.metadata?.date || '';
  const venue = meta?.metadata?.venue || '';
  const coverage = meta?.metadata?.coverage || '';
  const location = [venue, coverage].filter(Boolean).join(', ');
  currentShowTitle = title;
  $('#showTitle').textContent = title; show($('#showMeta'),true);
  if(date){ $('#showDate').textContent = new Date(date).toLocaleDateString(); show($('#showDate'),true);} else show($('#showDate'),false);
  if(location){ $('#showLoc').textContent = location; show($('#showLoc'),true);} else show($('#showLoc'),false);
}
function cleanTitle(name){ let t=name.replace(/\.(mp3|ogg|flac)$/i,''); t=t.replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim(); t=t.replace(/^(\d+)[\s.\-_]+/,''); return t; }
function naturalCmp(a,b){ return a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}); }
function extractTrackNo(f){ const n1=Number(f.track||f.trackno||''); if(!isNaN(n1)&&n1>0) return n1; const m=/(\d+)[^\d]*\.(mp3|ogg|flac)$/i.exec(f.name||''); if(m) return Number(m[1]); return Infinity; }

async function showShow(params){
  show($('#toolbar-bands'),false); show($('#toolbar-band'),false);
  $('#headerBandName').textContent = '';
  currentShowId = decodeURIComponent((params||[])[0]||'');

  const content=$('#content'); content.className='tracks'; content.innerHTML=`<div class="card"><span class="small">Loading tracks…</span></div>`;
  const load = async ()=>{
    try{
      const meta = await fetchJSON(IA.metaUrl(currentShowId));
      setShowHeader(meta);
      $('#favShowBtn').onclick = () => toggleFav(currentShowId); updateFavBtn();

      const files = meta?.files||[];
      let playable = files.filter(f => /\.mp3$/i.test(f.name||'') || (f.format||'').toLowerCase().includes('mp3'));
      if (playable.length===0){ playable = files.filter(f => /\.(ogg|flac)$/i.test(f.name||'') || /(ogg|flac)/.test((f.format||'').toLowerCase())); }

      playable.sort((a,b)=>{ const an=extractTrackNo(a), bn=extractTrackNo(b); if (an!==bn) return an-bn; return naturalCmp(a.name||'', b.name||''); });

      const seen=new Set(); trackList=[];
      for (const f of playable){
        const title = cleanTitle(f.title || f.name || '');
        const key = title.toLowerCase(); if (seen.has(key)) continue; seen.add(key);
        const url = `https://archive.org/download/${currentShowId}/${encodeURIComponent(f.name)}`;
        trackList.push({ url, title, length: f.length || '' });
      }

      if (!trackList.length){ content.innerHTML=`<div class="card"><span class="small">No playable files found.</span></div>`; return; }

      content.innerHTML = trackList.map((t,i)=>`
        <div class="track" data-i="${i}">
          <div class="tleft"><div class="tnum">${i+1}</div><div class="tname">${t.title}</div></div>
          <div class="tlen">${t.length}</div>
          <div class="progressBar" id="pb-${i}"></div>
        </div>`).join('');

      trackEls = $$('.track');
      content.onclick = ev => { const tr=ev.target.closest('.track'); if(!tr) return; playIndex(Number(tr.dataset.i)); };
    }catch(e){
      const msg = navigator.onLine ? 'Network error while loading tracks.' : 'You appear to be offline.';
      showRetry(content, msg, load);
    }
  };
  load();
}

/* ------------ Player & Media Session ------------ */
const A=$('#audio'); const P={ play:$('#P_play'), prev:$('#P_prev'), next:$('#P_next'), mute:$('#P_mute'), seek:$('#P_seek'), cur:$('#P_times .cur'), dur:$('#P_times .dur') };
const P_now = $('#P_now');
const volPop = $('#volPop'); const P_vol = $('#P_vol'); const volLabel = $('#volLabel');
let queue=[]; let curIndex=-1;

function setQueueFromTracks(){ queue = trackList.map(t=>t.url); }
function updateMediaSession(title='Playing', artist='Setlist Streamer'){
  try{
    if(!('mediaSession' in navigator)) return;
    navigator.mediaSession.metadata = new MediaMetadata({
      title, artist, album: 'Live Music Archive',
      artwork: [
        { src: 'icons/logo-96.png?v=3',  sizes:'96x96',  type:'image/png' },
        { src: 'icons/logo-192.png?v=3', sizes:'192x192', type:'image/png' },
        { src: 'icons/logo-256.png?v=3', sizes:'256x256', type:'image/png' },
        { src: 'icons/logo-512.png?v=3', sizes:'512x512', type:'image/png' }
      ]
    });
  }catch(e){}
}
function playIndex(i){
  if(!trackList.length) return;
  setQueueFromTracks();
  curIndex=Math.max(0,Math.min(i,queue.length-1));
  A.src=queue[curIndex];
  updateMediaSession(trackList[curIndex]?.title || 'Track');
  A.play().catch(()=>{});
  updateTrackHighlight();
  store.set('currentShowId', currentShowId);
  updateEqAnim();
}
function updateTrackHighlight(){ trackEls.forEach((el,idx)=>el.classList.toggle('playing', idx===curIndex)); }
P.play?.addEventListener('click', ()=>{ if(A.paused) A.play(); else A.pause(); });

/* Equalizer animation state */
const EQ = document.querySelector('#P_now .eqBars');
function updateEqAnim(){ if(EQ) EQ.classList.toggle('paused', A.paused); }
A.addEventListener('play',  ()=>{ P.play.textContent='⏸'; store.set('wasPlaying', true); updateEqAnim(); });
A.addEventListener('pause', ()=>{ P.play.textContent='▶️'; store.set('wasPlaying', false); updateEqAnim(); });
A.addEventListener('ended', ()=>{ updateEqAnim(); if(curIndex<queue.length-1) playIndex(curIndex+1); });

P.prev?.addEventListener('click', ()=>{ if(curIndex>0) playIndex(curIndex-1); });
P.next?.addEventListener('click', ()=>{ if(curIndex<queue.length-1) playIndex(curIndex+1); });

/* Volume controls */
function setVolumeUI(v){
  const pct = Math.round((v||0)*100);
  volLabel.textContent = pct+'%';
  P_mute.textContent = (A.muted || v===0) ? '🔇' : '🔈';
}
const P_mute = $('#P_mute');
const savedVol = Number(store.get('volume', 1));
A.volume = isNaN(savedVol)?1:Math.max(0,Math.min(1,savedVol));
P_vol.value = String(A.volume);
setVolumeUI(A.volume);

P_mute.addEventListener('click', ()=>{ volPop.classList.toggle('open'); });
document.addEventListener('click',(e)=>{
  const w = $('.volWrap');
  if(!w.contains(e.target)) volPop.classList.remove('open');
});
P_vol.addEventListener('input', ()=>{
  const v = Number(P_vol.value);
  A.volume = Math.max(0,Math.min(1,v));
  A.muted = (A.volume===0);
  store.set('volume', A.volume);
  setVolumeUI(A.volume);
});

/* Seek & time */
P.seek?.addEventListener('input', ()=>{ if(!A.duration||isNaN(A.duration)) return; A.currentTime=(P.seek.value/1000)*A.duration; });
A.addEventListener('timeupdate', ()=>{
  if(A.duration&&!isNaN(A.duration)){
    $('#P_times .cur').textContent=fmtTime(A.currentTime);
    $('#P_times .dur').textContent=' / '+fmtTime(A.duration);
    P.seek.value=Math.floor((A.currentTime/A.duration)*1000);
    if(curIndex>=0){ const pb=$('#pb-'+curIndex); if(pb) pb.style.width=`${(A.currentTime/A.duration)*100}%`; }
  }else{
    $('#P_times .cur').textContent='0:00';
    $('#P_times .dur').textContent=' / 0:00';
    P.seek.value=0;
  }
});

/* Equalizer button -> jump back to current show */
P_now.addEventListener('click', ()=>{
  const id = store.get('currentShowId', null) || currentShowId;
  if(id){ location.hash = '#/show/' + encodeURIComponent(id); }
});

/* Best-effort auto-resume on return/device change */
function markHideState(){ store.set('wasPlayingOnHide', !A.paused); }
function tryAutoResume(){
  if (store.get('wasPlayingOnHide', false)){
    A.play().catch(()=>{ /* autoplay block ignored */ });
  }
}
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden) markHideState(); else tryAutoResume();
});
window.addEventListener('pageshow', tryAutoResume);
window.addEventListener('focus', tryAutoResume);
if (navigator.mediaDevices && 'ondevicechange' in navigator.mediaDevices){
  navigator.mediaDevices.ondevicechange = () => { tryAutoResume(); };
}

/* ------------ wire routes ------------ */
Router.on('bands', showBands);
Router.on('band', showBand);
Router.on('show', showShow);

/* ------------ bands filters ------------ */
$('#sortSel')?.addEventListener('change', showBands);
$('#searchBox')?.addEventListener('change', showBands);
$('#resetBtn')?.addEventListener('click', ()=>{
  $('#sortSel').value='downloads desc';
  $('#searchBox').value='';
  location.hash='#/bands';
  onlyFavBands=false;
  $('#favToggle').textContent='☆ Favorites';
  showBands();
});

/* ------------ optional SW ------------ */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }

/* Init EQ state once DOM is ready */
document.addEventListener('DOMContentLoaded', ()=>{
  const EQ = document.querySelector('#P_now .eqBars'); if(EQ){ EQ.classList.toggle('paused', true);}
});
</script>
</body>
</html>
