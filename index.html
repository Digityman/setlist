<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live Music Archive ‚Äî Mobile Player</title>
<link rel="preconnect" href="https://archive.org">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<style>
  :root{
    --bg:#0f0f10; --panel:#161719; --text:#e9e9ea; --muted:#a6a6ac; --accent:#5bd19a;
    --btn:#232428; --ring:#2b2d31;
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit; text-decoration:none}

  .wrap{min-height:100%; display:flex; flex-direction:column}
  header{
    padding:14px 16px; display:flex; align-items:center; gap:10px; background:var(--panel); position:sticky; top:0; z-index:3;
    box-shadow:0 1px 0 #000 inset, 0 1px 0 rgba(255,255,255,.03);
  }
  header h1{font-size:18px; margin:0; white-space:nowrap}
  header .crumb{opacity:.75}

  /* Toolbar */
  .toolbar{display:flex; gap:8px; padding:10px 12px; align-items:center; flex-wrap:wrap}
  .pill{
    background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:8px 12px; display:flex; align-items:center; gap:8px;
  }
  select, input[type="search"]{
    background:transparent; color:var(--text); border:none; outline:none; font:14px system-ui; min-width:120px;
  }
  .btn{
    background:var(--btn); color:var(--text); border:1px solid var(--ring); border-radius:12px; padding:10px 12px;
    display:inline-flex; align-items:center; justify-content:center; gap:6px; min-width:40px; min-height:40px;
  }
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent}
  .muted{color:var(--muted)}

  /* Bands grid with thumbnails */
  .bandsGrid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap:10px;
    padding:0 12px 120px;
  }
  .bandTile{
    background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:10px;
    display:flex; flex-direction:column; gap:8px; cursor:pointer;
  }
  .bandTile img{
    width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; background:#0c0c0d;
  }
  .bandTitle{font-weight:600}
  .bandViews{font-size:12px; color:var(--muted)}

  /* List cards (used on concerts) */
  .grid{display:grid; grid-template-columns:1fr; gap:6px; padding:0 12px 120px}
  .card{
    background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:12px; display:flex; justify-content:space-between; align-items:center;
  }
  .card h3{margin:0; font-size:15px}
  .small{font-size:12px; color:var(--muted)}

  /* Player */
  .player{
    position:fixed; left:0; right:0; bottom:0; background:var(--panel);
    border-top:1px solid var(--ring); padding:10px; z-index:5;
  }
  .playerCompact .controls{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden}
  .playerCompact .btn{padding:4px 6px; min-height:32px; min-width:32px; border-radius:10px; font-size:13px}
  .playerCompact .seekWrap{
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:6px; min-width:140px; margin-left:auto;
  }
  .playerCompact #P_times{min-width:76px; font-size:12px; text-align:right}
  .playerCompact #P_times .dur{opacity:.8; margin-left:2px}
  .playerCompact #P_seek{width:100%; max-width:160px}
  .playerCompact #P_seekVis{left:10px; right:120px; max-width:160px}

  /* Hide +/-10s buttons entirely */
  #P_back10, #P_fwd10{ display:none !important; }

  input[type="range"]{
    -webkit-appearance:none; appearance:none; height:4px; border-radius:999px; background:#2a2c30; outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); border:none; box-shadow:0 0 0 3px rgba(91,209,154,.25);
  }

  .sp{flex:1 1 auto}
  .sr{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><a href="#/bands">Live Music Archive</a> <span class="crumb" id="crumb"></span></h1>
    <span id="routeInfo" class="small muted"></span>
  </header>

  <div class="toolbar" id="toolbar-bands">
    <div class="pill">
      <select id="sortSel" aria-label="Sort">
        <option value="downloads desc" selected>Views ‚Üì</option>
        <option value="downloads asc">Views ‚Üë</option>
        <option value="title asc">Title A‚ÜíZ</option>
        <option value="title desc">Title Z‚ÜíA</option>
      </select>
    </div>

    <div class="pill">
      <select id="subjectSel" aria-label="Subject">
        <option value="all" selected>All subjects</option>
      </select>
    </div>

    <div class="pill sp" style="min-width:160px;">
      <input id="searchBox" type="search" placeholder="e.g., Grateful Dead, bluegrass" style="width:100%;">
    </div>

    <button id="favToggle" class="btn">‚òÜ Favorites</button>
    <button id="resetBtn" class="btn ghost muted">Reset</button>
  </div>

  <!-- Band toolbar (shows on band route) -->
  <div class="toolbar" id="toolbar-band" style="display:none;">
    <button class="btn ghost" id="backToBands" title="Back">‚Üê Bands</button>
    <div class="pill">
      <select id="yearSel" aria-label="Year">
        <option value="">All years</option>
      </select>
    </div>
    <div class="pill sp" style="min-width:160px;">
      <input id="concertSearch" type="search" placeholder="Search concerts" style="width:100%;">
    </div>
  </div>

  <div id="content" class="grid" aria-live="polite"></div>
</div>

<!-- Player -->
<div class="player playerCompact" id="player">
  <div class="controls">
    <button id="P_prev" class="btn" title="Previous">‚èÆ</button>
    <button id="P_play" class="btn" title="Play/Pause">‚ñ∂Ô∏è</button>
    <button id="P_next" class="btn" title="Next">‚è≠</button>

    <div class="seekWrap">
      <div id="P_times">
        <span class="cur">0:00</span><span class="dur"> / 0:00</span>
      </div>
      <input id="P_seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
      <div class="sr" aria-hidden="true" id="P_seekVis"></div>
    </div>

    <button id="P_mute" class="btn" title="Mute">üîà</button>
  </div>
  <audio id="audio"></audio>
</div>

<script>
/* ------------------------------
   Utilities
------------------------------ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = secs => {
  secs = Math.max(0, Math.floor(secs || 0));
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m + ":" + String(s).padStart(2, "0");
};
function show(el, on=true){ if(!el) return; el.style.display = on ? '' : 'none'; }

/* ------------------------------
   Router (minimal, safe)
------------------------------ */
const Router = (() => {
  const routes = {};
  function on(name, fn){ routes[name] = fn; }
  function parse(){
    const raw = location.hash.replace(/^#\/?/, '');
    const [name, ...rest] = raw.split('/').filter(Boolean);
    return { name: name || 'bands', params: rest };
  }
  function route(){
    const r = parse();
    const handler = routes[r.name] || routes['bands'];
    if (typeof handler === 'function') handler(r.params);
    const crumb = $('#crumb');
    crumb.textContent = r.name === 'band' ? '‚Äî Concerts' : '‚Äî Bands';
  }
  return { on, route };
})();

window.addEventListener('hashchange', Router.route);
document.addEventListener('DOMContentLoaded', Router.route);

/* ------------------------------
   Archive.org helpers
------------------------------ */
const IA = {
  bandsUrl({ q = 'collection:(etree) AND mediatype:(collection)', sort = 'downloads desc', rows = 100, page = 1 } = {}){
    const u = new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q', q);
    u.searchParams.append('fl[]', 'identifier');
    u.searchParams.append('fl[]', 'title');
    u.searchParams.append('fl[]', 'downloads');
    u.searchParams.append('sort[]', sort);
    u.searchParams.set('rows', rows);
    u.searchParams.set('page', page);
    u.searchParams.set('output', 'json');
    return u.toString();
  },
  concertsUrl({ bandId, sort = 'date desc', rows = 200, year = '', term = '' }){
    // Search shows within a band's collection; filter by year if provided.
    let q = `collection:(${bandId}) AND mediatype:(etree OR audio)`;
    if (year) q += ` AND year:(${year})`;
    if (term) q += ` AND (title:(${term}) OR date:(${term}))`;

    const u = new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q', q);
    u.searchParams.append('fl[]','identifier');
    u.searchParams.append('fl[]','title');
    u.searchParams.append('fl[]','date');
    u.searchParams.append('fl[]','year');
    u.searchParams.append('fl[]','downloads');
    u.searchParams.append('sort[]', sort);
    u.searchParams.set('rows', rows);
    u.searchParams.set('page', 1);
    u.searchParams.set('output', 'json');
    return u.toString();
  },
  metaUrl(id){ return `https://archive.org/metadata/${id}`; },
  imgUrl(id){ return `https://archive.org/services/img/${id}`; },
  async fetchJSON(url){
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Network ' + res.status);
    return res.json();
  }
};

/* ------------------------------
   Bands screen (with images)
------------------------------ */
async function showBands(){
  show($('#toolbar-bands'), true);
  show($('#toolbar-band'), false);

  const content = $('#content');
  if (!content) return;
  content.className = 'bandsGrid';
  content.innerHTML = `<div class="card"><span class="small muted">Loading top bands‚Ä¶</span></div>`;

  const sortSel = $('#sortSel');
  const searchBox = $('#searchBox');

  const sort = sortSel?.value || 'downloads desc';
  const term = (searchBox?.value || '').trim();

  let q = 'collection:(etree) AND mediatype:(collection)';
  if (term) q += ` AND (title:(${term}) OR identifier:(${term}))`;

  try{
    const data = await IA.fetchJSON(IA.bandsUrl({ q, sort, rows: 100 }));
    const items = (data?.response?.docs || []).map(d => ({
      id: d.identifier, title: d.title || d.identifier, downloads: d.downloads || 0
    }));

    if (!items.length){
      content.innerHTML = `<div class="card"><span class="small">No results.</span></div>`;
      return;
    }

    content.innerHTML = items.map(b => `
      <div class="bandTile" data-id="${b.id}">
        <img src="${IA.imgUrl(b.id)}" alt="${b.title}">
        <div class="bandTitle">${b.title}</div>
        <div class="bandViews">${b.downloads.toLocaleString()} views</div>
      </div>
    `).join('');

    content.onclick = (ev) => {
      const tile = ev.target.closest('.bandTile');
      if (!tile) return;
      const id = tile.getAttribute('data-id');
      location.hash = '#/band/' + encodeURIComponent(id);
    };
  }catch(err){
    console.error(err);
    content.className = 'grid';
    content.innerHTML = `<div class="card"><span class="small">Failed to load bands. Check network/CORS.</span></div>`;
  }
}

/* ------------------------------
   Band screen (concert list + Year filter)
------------------------------ */
let currentBandId = '';
let currentConcerts = [];

async function showBand(params){
  show($('#toolbar-bands'), false);
  show($('#toolbar-band'), true);

  const [idRaw] = params || [];
  const id = decodeURIComponent(idRaw || '');
  currentBandId = id;

  $('#backToBands').onclick = () => location.hash = '#/bands';

  const content = $('#content');
  if (!content) return;
  content.className = 'grid';
  content.innerHTML = `
    <div class="card"><span class="small muted">Loading concerts for <b>${id}</b>‚Ä¶</span></div>
  `;

  try{
    // initial fetch (no year filter)
    const data = await IA.fetchJSON(IA.concertsUrl({ bandId:id, sort:'date desc', rows:500 }));
    const docs = (data?.response?.docs || []);
    currentConcerts = docs;

    // Build Year options (desc)
    const years = [...new Set(docs.map(d => d.year).filter(Boolean))]
      .map(Number).filter(n => !isNaN(n)).sort((a,b)=>b-a);
    const yearSel = $('#yearSel');
    yearSel.innerHTML = `<option value="">All years</option>` + years.map(y=>`<option value="${y}">${y}</option>`).join('');
    yearSel.onchange = () => renderConcerts();
    $('#concertSearch').onchange = () => renderConcerts();

    renderConcerts();
  }catch(err){
    console.error(err);
    content.innerHTML = `<div class="card"><span class="small">Failed to load concerts.</span></div>`;
  }
}

function renderConcerts(){
  const content = $('#content');
  if (!content) return;
  const year = $('#yearSel')?.value || '';
  const term = ($('#concertSearch')?.value || '').trim().toLowerCase();

  let list = currentConcerts.slice();
  if (year) list = list.filter(d => String(d.year) === String(year));
  if (term) list = list.filter(d => (d.title||'').toLowerCase().includes(term) || (d.date||'').toLowerCase().includes(term));

  if (!list.length){
    content.innerHTML = `<div class="card"><span class="small">No concerts found.</span></div>`;
    return;
  }

  content.innerHTML = list.map(it => {
    const date = it.date ? new Date(it.date).toLocaleDateString() : (it.year || '');
    return `
      <div class="card" data-id="${it.identifier}">
        <div>
          <h3>${it.title || it.identifier}</h3>
          <div class="small muted">${date} ‚Ä¢ ${Number(it.downloads||0).toLocaleString()} views</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn playShow">Play</button>
          <a class="btn ghost" href="https://archive.org/details/${it.identifier}" target="_blank" rel="noopener">Open</a>
        </div>
      </div>
    `;
  }).join('');

  content.onclick = async (ev) => {
    const card = ev.target.closest('.card');
    if (!card) return;
    if (ev.target.classList.contains('playShow')) {
      const id = card.getAttribute('data-id');
      await playFirstMp3(id);
    }
  };
}

/* ------------------------------
   Player logic (no ¬±10s buttons)
------------------------------ */
const A = $('#audio');
const P = {
  play: $('#P_play'),
  prev: $('#P_prev'),
  next: $('#P_next'),
  mute: $('#P_mute'),
  seek: $('#P_seek'),
  cur: $('#P_times .cur'),
  dur: $('#P_times .dur')
};

let queue = [];
let curIndex = -1;

async function playFirstMp3(identifier){
  try{
    const meta = await IA.fetchJSON(IA.metaUrl(identifier));
    const files = meta?.files || [];
    const mp3 = files.find(f => (f.format||'').toLowerCase().includes('mp3') && f.name && f.name.endsWith('.mp3'));
    if (!mp3) throw new Error('No MP3 found');
    const url = `https://archive.org/download/${identifier}/${encodeURIComponent(mp3.name)}`;
    queue = [url]; curIndex = 0;
    A.src = url; A.play().catch(()=>{});
  }catch(e){
    console.warn('Could not play show:', e);
  }
}

function load(i){
  curIndex = Math.max(0, Math.min(i, queue.length-1));
  A.src = queue[curIndex];
  A.play().catch(()=>{});
}

P.play?.addEventListener('click', () => { if (A.paused) A.play(); else A.pause(); });
P.prev?.addEventListener('click', () => load(Math.max(0, curIndex-1)));
P.next?.addEventListener('click', () => load(Math.min(queue.length-1, curIndex+1)));
P.mute?.addEventListener('click', () => { A.muted = !A.muted; });

P.seek?.addEventListener('input', () => {
  if (!A.duration || isNaN(A.duration)) return;
  const t = (P.seek.value / 1000) * A.duration;
  A.currentTime = t;
});

A.addEventListener('timeupdate', () => {
  if (A.duration && !isNaN(A.duration)) {
    P.cur.textContent = fmtTime(A.currentTime);
    P.dur.textContent = ' / ' + fmtTime(A.duration);
    P.seek.value = Math.floor((A.currentTime / A.duration) * 1000);
  } else {
    P.cur.textContent = '0:00';
    P.dur.textContent = ' / 0:00';
    P.seek.value = 0;
  }
});

A.addEventListener('play',  () => { P.play.textContent = '‚è∏'; });
A.addEventListener('pause', () => { P.play.textContent = '‚ñ∂Ô∏è'; });

/* ------------------------------
   Wire routes
------------------------------ */
Router.on('bands', showBands);
Router.on('band', showBand);

/* ------------------------------
   Filters for bands
------------------------------ */
$('#sortSel')?.addEventListener('change', showBands);
$('#searchBox')?.addEventListener('change', showBands);
$('#resetBtn')?.addEventListener('click', () => {
  $('#sortSel').value = 'downloads desc';
  $('#searchBox').value = '';
  location.hash = '#/bands';
  showBands();
});

/* ------------------------------
   Service worker (optional)
------------------------------ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(console.warn);
}
</script>
</body>
</html>
