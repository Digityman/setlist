<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Setlist Streamer</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f10">
<link rel="icon" href="icons/logo-32.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="icons/logo-180.png" sizes="180x180">

<style>
  :root{
    --bg:#0f0f10; --panel:#161719; --text:#e9e9ea; --muted:#a6a6ac; --accent:#47c46b;
    --card:#1b1c20; --soft:#23252a; --soft2:#2b2d33;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer;border:0;background:transparent;color:inherit}
  img{display:block;max-width:100%}

  /* Layout */
  header{
    position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f0f10, #0f0f10cc 80%, #0f0f1000);
    display:grid;grid-template-columns:48px 1fr 48px;align-items:center;padding:10px 8px 6px 8px;gap:6px;
    backdrop-filter:saturate(1.1) blur(10px);
  }
  #hamburger{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;background:var(--panel)}
  #hamburger .bars{width:18px;height:12px;display:grid;gap:3px}
  #hamburger .bars span{display:block;height:2px;background:#e9e9ea;border-radius:2px}

  #title{ text-align:center;font-weight:650;letter-spacing:.2px}
  #topRight{display:flex;gap:8px;justify-content:flex-end}
  .pill{padding:8px 10px;border-radius:999px;background:var(--panel);font-size:12px}

  main{padding:10px; padding-bottom:90px; max-width:1100px;margin:0 auto}
  .sectionTitle{font-size:18px;margin:8px 4px 10px}

  /* Drawer */
  #drawer{
    position:fixed;inset:0 30% 0 0;max-width:360px;transform:translateX(-100%);
    transition:transform .25s ease;z-index:40;background:var(--panel);box-shadow:8px 0 20px #0007
  }
  #drawer.open{transform:none}
  #drawer header{position:sticky;top:0;background:var(--panel)}
  #drawer .menu{padding:8px}
  #drawer .item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;background:var(--soft);margin-bottom:8px}
  #backdrop{
    position:fixed;inset:0;display:none;background:#0008;z-index:30
  }
  #backdrop.show{display:block}

  /* Grids */
  .grid{display:grid;gap:10px}
  .bands{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .cards{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .list{display:grid;gap:8px}

  /* Cards / tiles */
  .card,.tile{background:var(--card);border-radius:16px;padding:12px}
  .tile{display:flex;align-items:center;gap:10px}
  .tile .thumb{width:44px;height:44px;border-radius:12px;background:var(--soft2);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}

  /* Buttons */
  .btn{padding:8px 10px;border-radius:12px;background:var(--soft);display:inline-flex;align-items:center;gap:6px}
  .btn:active{transform:scale(.98)}
  .btnAccent{background:var(--accent);color:#0a0f0c;font-weight:600}

  /* Badges/icons */
  .fav{font-size:16px}
  .fav.active{color:var(--accent)}
  .tag{font-size:11px;color:#0a0f0c;background:var(--accent);padding:2px 6px;border-radius:999px}

  /* Player */
  #player{
    position:fixed;left:10px;right:10px;bottom:10px;z-index:25;background:var(--panel);
    border:1px solid #ffffff14;border-radius:16px;padding:10px 12px;display:grid;gap:8px
  }
  #now{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  #now .title{font-weight:600}
  #now .sub{font-size:12px;color:var(--muted)}
  #controls{display:flex;gap:8px;align-items:center}
  #controls .btn{min-width:36px;height:36px;border-radius:10px}
  .eqBars{width:12px;height:14px;display:inline-grid;grid-auto-flow:column;gap:2px;align-items:end}
  .eqBars span{width:2px;background:#47c46b;animation:up 900ms infinite ease-in-out}
  .eqBars span:nth-child(2){animation-delay:.15s}
  .eqBars span:nth-child(3){animation-delay:.3s}
  .eqBars.paused span{animation:none;height:4px}
  @keyframes up{0%,100%{height:4px}50%{height:12px}}

  /* Empty / helper */
  .empty{padding:18px;border:1px dashed #ffffff25;border-radius:14px;color:#b9bac2;text-align:center}

  /* Responsive tweaks for smaller phones */
  @media (max-width:420px){
    header{grid-template-columns:44px 1fr 44px}
    .bands{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  }
</style>
</head>
<body>

<header>
  <button id="hamburger" aria-label="Open menu"><div class="bars"><span></span><span></span><span></span></div></button>
  <div id="title">Setlist Stream ‚Äì Bands / Concerts / Tracks</div>
  <div id="topRight">
    <a class="pill" href="#/bands" id="toBands">Bands</a>
    <a class="pill" href="#/favorites" id="toFavs">Favorites</a>
  </div>
</header>

<div id="backdrop"></div>
<aside id="drawer" aria-hidden="true">
  <header style="display:flex;align-items:center;gap:8px;padding:10px">
    <div class="tag">Menu</div>
  </header>
  <div class="menu">
    <a class="item" href="#/bands"><span>üéµ</span> <div>Bands</div></a>
    <a class="item" href="#/favorites"><span>‚≠ê</span> <div>Favorites</div></a>
    <a class="item" href="#/recent"><span>‚è±Ô∏è</span> <div>Recently Played</div></a>
    <a class="item" href="#/playlist/fav-songs"><span>üìª</span> <div>Favorite Songs</div></a>
    <a class="item" href="#/playlist/recent-songs"><span>üïò</span> <div>Recent Songs</div></a>
    <a class="item" href="#/about"><span>‚ÑπÔ∏è</span> <div>About</div></a>
  </div>
</aside>

<main id="app"></main>

<section id="player" hidden>
  <div id="now">
    <div>
      <div class="row" style="gap:10px">
        <div class="eqBars" id="eq"><span></span><span></span><span></span></div>
        <div class="title" id="nowTitle">‚Äî</div>
      </div>
      <div class="sub" id="nowMeta">‚Äî</div>
    </div>
    <div id="controls">
      <button class="btn" id="btnBack10" title="Back 10s">‚è™10</button>
      <button class="btn btnAccent" id="btnPlay">‚ñ∂Ô∏è</button>
      <button class="btn" id="btnFwd30" title="Fwd 30s">‚è©30</button>
      <button class="btn" id="btnStop" title="Stop">‚èπÔ∏è</button>
    </div>
  </div>
  <audio id="audio" crossorigin="anonymous"></audio>
</section>

<script>
/* Debug toggle: set true while developing */
const DEBUG=false; const log=DEBUG?console.log.bind(console):()=>{}; const warn=DEBUG?console.warn.bind(console):()=>{}; const err=console.error.bind(console);

/* State (simple global store) */
const S = {
  bands: [],               // [{id,name,thumb}]
  shows: [],               // current band shows list
  tracks: [],              // current show tracks
  currentBand:null,        // {id,name}
  currentShow:null,        // {id,date,location}
  route:'',                // current hash route segment
  cache:{},                // in-memory read-through cache
};
const LS = {
  get(k,def){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(def)); }catch{ return def; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const FAV = {
  bands: LS.get('favBands',[]),
  concerts: LS.get('favConcerts',[]),
  songs: LS.get('favSongs',[]),
  save(){ LS.set('favBands',FAV.bands); LS.set('favConcerts',FAV.concerts); LS.set('favSongs',FAV.songs); }
};
const RECENT = {
  songs: LS.get('recentSongs',[]),
  push(song){ // keep short list
    const key = `${song.band}::${song.showId}::${song.title}`;
    RECENT.songs = [song, ...RECENT.songs.filter(s=>`${s.band}::${s.showId}::${s.title}`!==key)].slice(0,100);
    LS.set('recentSongs', RECENT.songs);
  }
};

/* Small helpers */
const $ = sel => document.querySelector(sel);
const app = $('#app');
function html(strings,...vals){ return strings.map((s,i)=>s+(vals[i]??'')).join(''); }
function titleSorter(a,b){ return a.name?.localeCompare(b.name || '') ?? 0; } // alpha sort by name
function cacheKey(url){ return 'ia:' + url; }

/* JSON fetch with localStorage cache + basic fallback */
async function iaFetchJSON(url, {ttl=3600} = {}){
  const key = cacheKey(url);
  const now = Date.now();
  // read-through cache
  try{
    const cached = JSON.parse(localStorage.getItem(key) || 'null');
    if (cached && (now - cached.t) < ttl*1000) {
      log('cache hit', key);
      return cached.v;
    }
  }catch(e){}

  log('fetch', url);
  const resp = await fetch(url, {mode:'cors'}); // Archive APIs allow CORS
  if(!resp.ok) throw new Error('HTTP '+resp.status);
  const data = await resp.json();

  try{ localStorage.setItem(key, JSON.stringify({t:now, v:data})); }catch(e){}
  return data;
}

/* Router */
window.addEventListener('hashchange', onRoute);
window.addEventListener('load', () => { onRoute(); registerSW(); });

function onRoute(){
  const hash = location.hash.replace(/^#!/,'#'); // just in case
  const seg = hash.slice(2) || 'bands';          // strip "#/"
  S.route = seg;
  closeDrawer();

  const [base, a, b] = seg.split('/');
switch(base){
  case 'bands': return renderBands();
  case 'band': return renderBand(a);
  case 'show': return renderShow(a);
  case 'favorites': return renderFavorites();
  case 'recent':
  case 'playlist':
    if (a==='fav-songs' || (base==='playlist' && a==='fav-songs')) return renderPlaylist('fav-songs');
    if (a==='recent-songs' || base==='recent') return renderPlaylist('recent-songs');
    return renderRecent();
  case 'about': return renderAbout();
  case 'onthisday': return showOnThisDay();   // ‚Üê new
  default: return renderBands();
}

/* UI: Drawer toggles */
const drawer = $('#drawer'), backdrop = $('#backdrop'), hamburger = $('#hamburger');
hamburger.addEventListener('click', openDrawer);
backdrop.addEventListener('click', closeDrawer);
function openDrawer(){ drawer.classList.add('open'); backdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }

/* Views */
async function renderBands(){
  $('#title').textContent = 'Setlist Stream ‚Äì Bands';
  // Example band seed: You likely populate from Archive.org collections.
  // Keep this hook: if you already load from API, replace the static example.
  if (!S.bands.length){
    // Dummy minimal list if API not yet wired; replace with your real list loader.
    S.bands = [
      {id:'GratefulDead', name:'Grateful Dead', thumb:'GD'},
      {id:'Phish', name:'Phish', thumb:'PH'},
      {id:'BillyStrings', name:'Billy Strings', thumb:'BS'},
      {id:'GooseTheBand', name:'Goose', thumb:'GO'},
    ].sort(titleSorter);
  }
  app.innerHTML = html`
    <div class="sectionTitle">Bands</div>
    <div class="grid bands">
      ${S.bands.map(b=>html`
        <a class="tile" href="#/band/${b.id}">
          <div class="thumb">${b.thumb || b.name?.slice(0,2).toUpperCase()}</div>
          <div style="flex:1">
            <div class="row">
              <div>${b.name}</div>
              <button class="fav ${FAV.bands.includes(b.id)?'active':''}" data-band="${b.id}" title="Favorite">‚òÖ</button>
            </div>
            <div class="muted">${b.id}</div>
          </div>
        </a>
      `).join('')}
    </div>
  `;
  app.querySelectorAll('.fav[data-band]').forEach(btn=>{
    btn.onclick = e=>{
      const id = btn.dataset.band;
      const i = FAV.bands.indexOf(id);
      if(i>=0) FAV.bands.splice(i,1); else FAV.bands.push(id);
      FAV.save(); btn.classList.toggle('active', FAV.bands.includes(id));
    };
  });
}

async function renderBand(bandId){
  $('#title').textContent = 'Setlist Stream ‚Äì Concerts';
  S.currentBand = S.bands.find(b=>b.id===bandId) || {id:bandId, name:bandId};
  // Example Archive query pattern (tweak for your collections)
  // sorts=downloads desc to show popular first; you can switch to date asc/desc
  const url = `https://archive.org/advancedsearch.php?q=collection%3A${encodeURIComponent(bandId)}+AND+mediatype%3Aaudio&fl%5B%5D=identifier&fl%5B%5D=date&fl%5B%5D=title&fl%5B%5D=coverage&sort%5B%5D=downloads+desc&output=json`;
  let shows = [];
  try{
    const data = await iaFetchJSON(url, {ttl:6*3600});
    const docs = data?.response?.docs ?? [];
    shows = docs.map(d=>({
      id: d.identifier,
      date: (d.date||'').slice(0,10),
      title: d.title || d.identifier,
      location: d.coverage || ''
    }));
  }catch(e){ warn(e); }

  S.shows = shows;
  if(!shows.length){
    app.innerHTML = `<div class="empty">No concerts found for ${S.currentBand.name}.</div>`;
    return;
  }
  app.innerHTML = html`
    <div class="sectionTitle">${S.currentBand.name} ‚Äì Concerts</div>
    <div class="grid cards">
      ${shows.map(s=>html`
        <a class="card" href="#/show/${s.id}">
          <div class="row"><div style="font-weight:600">${s.title}</div>
            <button class="fav ${FAV.concerts.includes(s.id)?'active':''}" data-show="${s.id}" title="Favorite concert">‚òÖ</button>
          </div>
          <div class="muted">${s.location || '‚Äî'}</div>
          <div class="muted">${s.date || '‚Äî'}</div>
        </a>
      `).join('')}
    </div>
  `;
  app.querySelectorAll('.fav[data-show]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.show;
      const i = FAV.concerts.indexOf(id);
      if(i>=0) FAV.concerts.splice(i,1); else FAV.concerts.push(id);
      FAV.save(); btn.classList.toggle('active', FAV.concerts.includes(id));
    };
  });
}

async function renderShow(showId){
  $('#title').textContent = 'Setlist Stream ‚Äì Tracks';
  S.currentShow = { id:showId };
  let files=[];
  try{
    const data = await iaFetchJSON(`https://archive.org/metadata/${encodeURIComponent(showId)}`, {ttl:6*3600});
    const meta = data || {};
    const band = meta?.metadata?.creator || meta?.metadata?.collection?.[0] || 'Unknown Band';
    const date = meta?.metadata?.date || '';
    const location = meta?.metadata?.coverage || '';
    S.currentShow = { id:showId, band, date, location };
    files = (meta?.files||[]).filter(f=>/\.(mp3|ogg|flac)$/i.test(f.name)).map(f=>({
      title: (f.title || f.track || f.name || '').replace(/\.(mp3|ogg|flac)$/i,''),
      url: `https://archive.org/download/${encodeURIComponent(showId)}/${encodeURIComponent(f.name)}`
    }));
  }catch(e){ warn(e); }

  S.tracks = files;
  if(!files.length){
    app.innerHTML = `<div class="empty">No audio tracks found.</div>`;
    return;
  }

  app.innerHTML = html`
    <div class="sectionTitle">${S.currentShow.band || '‚Äî'} ‚Ä¢ ${S.currentShow.location || '‚Äî'} ‚Ä¢ ${S.currentShow.date || '‚Äî'}</div>
    <div class="list">
      ${files.map((t,i)=>html`
        <div class="tile">
          <div class="thumb">#${String(i+1).padStart(2,'0')}</div>
          <div style="flex:1">
            <div class="row">
              <div>${t.title}</div>
              <div class="row" style="gap:6px">
                <button class="fav ${isFavSong(S.currentShow.id,t.title)?'active':''}" data-song="${encodeURIComponent(t.title)}" title="Favorite song">‚òÖ</button>
                <button class="btn play" data-idx="${i}">Play</button>
              </div>
            </div>
            <div class="muted" style="font-size:12px">${S.currentShow.band}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;

  app.querySelectorAll('.btn.play').forEach(btn=>{
    btn.onclick = ()=>{
      const idx = +btn.dataset.idx;
      startTrack(idx);
    };
  });
  app.querySelectorAll('.fav[data-song]').forEach(btn=>{
    btn.onclick = ()=>{
      const title = decodeURIComponent(btn.dataset.song);
      toggleFavSong(S.currentShow.id, title, S.currentShow.band);
      btn.classList.toggle('active', isFavSong(S.currentShow.id,title));
    };
  });
}

function renderFavorites(){
  $('#title').textContent = 'Setlist Stream ‚Äì Favorites';
  const favBands = S.bands.filter(b=>FAV.bands.includes(b.id));
  const favShows = S.shows.filter(s=>FAV.concerts.includes(s.id));
  app.innerHTML = html`
    <div class="sectionTitle">Favorite Bands</div>
    ${favBands.length? html`
      <div class="grid bands">
        ${favBands.map(b=>html`
          <a class="tile" href="#/band/${b.id}">
            <div class="thumb">${b.thumb || b.name?.slice(0,2).toUpperCase()}</div>
            <div class="row" style="flex:1">
              <div>${b.name}</div><span class="tag">Band</span>
            </div>
          </a>
        `).join('')}
      </div>` : `<div class="empty">No favorite bands yet.</div>`}
    <div class="sectionTitle" style="margin-top:16px">Favorite Concerts</div>
    ${favShows.length? html`
      <div class="grid cards">
        ${favShows.map(s=>html`
          <a class="card" href="#/show/${s.id}">
            <div class="row"><div style="font-weight:600">${s.title||s.id}</div><span class="tag">Concert</span></div>
            <div class="muted">${s.location||'‚Äî'}</div>
            <div class="muted">${s.date||'‚Äî'}</div>
          </a>
        `).join('')}
      </div>` : `<div class="empty">No favorite concerts yet.</div>`}
    <div class="sectionTitle" style="margin-top:16px">Songs</div>
    <div class="row" style="gap:8px">
      <a class="btn" href="#/playlist/fav-songs">Open Favorite Songs</a>
      <a class="btn" href="#/playlist/recent-songs">Open Recent Songs</a>
    </div>
  `;
}

function renderRecent(){
  $('#title').textContent = 'Setlist Stream ‚Äì Recently Played';
  app.innerHTML = html`
    <div class="sectionTitle">Recently Played</div>
    ${RECENT.songs.length ? html`
      <div class="list">
        ${RECENT.songs.map(s=>html`
          <div class="tile">
            <div class="thumb">‚ô™</div>
            <div style="flex:1">
              <div class="row">
                <div>${s.title}</div>
                <div class="row" style="gap:6px">
                  <button class="btn" onclick="location.hash='#/show/${s.showId}'">Open Show</button>
                  <button class="btn" onclick="playDirect('${encodeURIComponent(s.url)}','${encodeURIComponent(s.title)}','${encodeURIComponent(s.band)}','${encodeURIComponent(s.showId)}')">Play</button>
                </div>
              </div>
              <div class="muted" style="font-size:12px">${s.band}</div>
            </div>
          </div>
        `).join('')}
      </div>` : `<div class="empty">No recent songs yet.</div>`}
  `;
}

function renderPlaylist(kind){ // 'fav-songs' | 'recent-songs'
  $('#title').textContent = kind==='fav-songs' ? 'Setlist Stream ‚Äì Favorite Songs' : 'Setlist Stream ‚Äì Recent Songs';
  const songs = kind==='fav-songs' ? FAV.songs : RECENT.songs;
  if(!songs.length){
    app.innerHTML = `<div class="empty">No ${kind==='fav-songs'?'favorite':'recent'} songs yet.</div>`;
    return;
  }
  app.innerHTML = html`
    <div class="sectionTitle">${kind==='fav-songs'?'Favorite Songs':'Recently Played Songs'}</div>
    <div class="list">
      ${songs.map((s,i)=>html`
        <div class="tile">
          <div class="thumb">${kind==='fav-songs'?'‚òÖ':'‚è±Ô∏è'}</div>
          <div style="flex:1">
            <div class="row">
              <div>${s.title}</div>
              <div class="row" style="gap:6px">
                <button class="btn" onclick="location.hash='#/show/${s.showId}'">Open Show</button>
                <button class="btn" onclick="playDirect('${encodeURIComponent(s.url)}','${encodeURIComponent(s.title)}','${encodeURIComponent(s.band)}','${encodeURIComponent(s.showId)}')">Play</button>
              </div>
            </div>
            <div class="muted" style="font-size:12px">${s.band}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderAbout(){
  $('#title').textContent = 'Setlist Stream ‚Äì About';
  app.innerHTML = `
    <div class="card">
      <div style="font-weight:600;margin-bottom:6px">About</div>
      <div class="muted">Single-file PWA that streams Archive.org live shows. Use the left menu for bands, favorites, and playlists.</div>
    </div>
  `;
}

/* Favorites helpers */
function isFavSong(showId, title){ return FAV.songs.some(s=>s.showId===showId && s.title===title); }
function toggleFavSong(showId, title, band){
  const idx = FAV.songs.findIndex(s=>s.showId===showId && s.title===title);
  if(idx>=0) FAV.songs.splice(idx,1);
  else{
    // Find track URL from S.tracks
    const t = S.tracks.find(x=>x.title===title);
    if(!t) return;
    FAV.songs.unshift({showId, title, band, url:t.url});
    FAV.songs = FAV.songs.slice(0,500);
  }
  FAV.save();
}

/* Player */
const P = {
  el: $('#player'),
  audio: $('#audio'),
  nowTitle: $('#nowTitle'),
  nowMeta: $('#nowMeta'),
  eq: $('#eq'),
  btnPlay: $('#btnPlay'),
};
$('#btnBack10').onclick = ()=>{ P.audio.currentTime = Math.max(0, P.audio.currentTime - 10); updatePositionState(); };
$('#btnFwd30').onclick = ()=>{ P.audio.currentTime = Math.min((P.audio.duration||0), P.audio.currentTime + 30); updatePositionState(); };
$('#btnPlay').onclick = ()=>{ if(P.audio.paused) P.audio.play(); else P.audio.pause(); };
$('#btnStop').onclick = ()=>{ stopPlayback(); };

P.audio.addEventListener('play',  onPlayPause);
P.audio.addEventListener('pause', onPlayPause);
P.audio.addEventListener('ended', onPlayPause);
P.audio.addEventListener('timeupdate', throttle(updatePositionState, 800));

function startTrack(idx){
  const t = S.tracks[idx];
  if(!t) return;
  playDirect(encodeURIComponent(t.url), encodeURIComponent(t.title), encodeURIComponent(S.currentShow.band||''), encodeURIComponent(S.currentShow.id));
}
function playDirect(encUrl, encTitle, encBand, encShowId){
  const url = decodeURIComponent(encUrl);
  const title = decodeURIComponent(encTitle);
  const band = decodeURIComponent(encBand);
  const showId = decodeURIComponent(encShowId);
  P.audio.src = url;
  P.el.hidden = false;
  P.audio.play().catch(()=>{});
  P.nowTitle.textContent = title;
  const metaLine = `${band}${S.currentShow?.location?' ‚Ä¢ '+S.currentShow.location:''}${S.currentShow?.date?' ‚Ä¢ '+S.currentShow.date:''}`;
  P.nowMeta.textContent = metaLine;
  updateMediaSession(title, band, S.currentShow?.location||'', S.currentShow?.date||'');
  RECENT.push({title, band, url, showId});
}
function stopPlayback(){
  P.audio.pause(); P.audio.currentTime = 0; P.audio.removeAttribute('src'); P.el.hidden = true;
  updateMediaSession('', '', '', '');
}
function onPlayPause(){
  P.eq.classList.toggle('paused', P.audio.paused);
  $('#btnPlay').textContent = P.audio.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
  updatePositionState();
}

/* Media Session */
function updateMediaSession(title, band, location, date){
  if(!('mediaSession' in navigator)) return;
  try{
    navigator.mediaSession.metadata = title ? new MediaMetadata({
      title, artist: band || '‚Äî', album: (location||'') + (date?` ‚Ä¢ ${date}`:'')
    }) : null;
    navigator.mediaSession.setActionHandler('play',  ()=>P.audio.play());
    navigator.mediaSession.setActionHandler('pause', ()=>P.audio.pause());
    navigator.mediaSession.setActionHandler('stop',  ()=>stopPlayback());
    navigator.mediaSession.setActionHandler('seekbackward', (d)=>{ P.audio.currentTime = Math.max(0, P.audio.currentTime - (d.seekOffset||10)); updatePositionState(); });
    navigator.mediaSession.setActionHandler('seekforward',  (d)=>{ P.audio.currentTime = Math.min((P.audio.duration||0), P.audio.currentTime + (d.seekOffset||30)); updatePositionState(); });
    navigator.mediaSession.setActionHandler('seekto',        (d)=>{ if(d.fastSeek && 'fastSeek' in P.audio) P.audio.fastSeek(d.seekTime); else P.audio.currentTime = d.seekTime; updatePositionState(); });
  }catch(e){/* ignore */}
}
function updatePositionState(){
  if(!('mediaSession' in navigator)) return;
  try{
    navigator.mediaSession.setPositionState({
      duration: Number.isFinite(P.audio.duration) ? P.audio.duration : 0,
      playbackRate: 1,
      position: Number.isFinite(P.audio.currentTime) ? P.audio.currentTime : 0
    });
  }catch(e){}
}

/* Small utils */
function throttle(fn, ms){
  let t=0; return (...a)=>{ const n=Date.now(); if(n-t>=ms){ t=n; fn(...a);} };
}

/* SW (optional; if you have /sw.js present) */
function registerSW(){
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
}
</script>
</body>
</html>
