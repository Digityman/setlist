<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Live Music Archive ‚Äî Mobile Player</title>
<link rel="preconnect" href="https://archive.org">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icons/icon-192.png">
<style>
  :root{
    --bg:#0f0f10; --panel:#161719; --text:#e9e9ea; --muted:#a6a6ac; --accent:#5bd19a;
    --btn:#232428; --ring:#2b2d31; --warn:#ffd54a;
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit; text-decoration:none}

  .wrap{min-height:100%; display:flex; flex-direction:column}
  header{
    padding:14px 16px; display:flex; align-items:center; gap:10px; background:var(--panel); position:sticky; top:0; z-index:3;
    box-shadow:0 1px 0 #000 inset, 0 1px 0 rgba(255,255,255,.03);
  }
  header h1{font-size:18px; margin:0; white-space:nowrap}
  header .crumb{opacity:.75}

  /* Toolbars */
  .toolbar{display:flex; gap:8px; padding:10px 12px; align-items:center; flex-wrap:wrap}
  .pill{
    background:var(--panel); border:1px solid var(--ring); border-radius:999px; padding:8px 12px; display:flex; align-items:center; gap:8px;
  }
  select, input[type="search"]{
    background:transparent; color:var(--text); border:none; outline:none; font:14px system-ui; min-width:120px;
  }
  .btn{
    background:var(--btn); color:var(--text); border:1px solid var(--ring); border-radius:12px; padding:10px 12px;
    display:inline-flex; align-items:center; justify-content:center; gap:6px; min-width:40px; min-height:40px;
  }
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent}
  .muted{color:var(--muted)}

  /* Bands grid ‚Äî smaller tiles so ‚â•5 per row */
  .bandsGrid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* <= makes 5‚Äì8 per row depending on width */
    gap:10px;
    padding:0 12px 120px;
  }
  .bandTile{
    background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:8px;
    display:flex; flex-direction:column; gap:6px; cursor:pointer;
  }
  .bandTile img{
    width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; background:#0c0c0d;
  }
  .bandTitle{font-weight:600; font-size:13px}
  .bandViews{font-size:11px; color:var(--muted)}

  /* Generic list cards (concerts) */
  .grid{display:grid; grid-template-columns:1fr; gap:6px; padding:0 12px 120px}
  .card{
    background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:12px; display:flex; justify-content:space-between; align-items:center;
  }
  .card h3{margin:0; font-size:15px}
  .small{font-size:12px; color:var(--muted)}

  /* Track list styles (Show page) */
  .tracks{display:grid; gap:6px; padding:0 12px 120px}
  .track{
    position:relative; background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:10px 12px; display:flex; align-items:center; gap:10px;
  }
  .track .playBtn{min-width:36px; min-height:36px; border-radius:10px}
  .track .meta{display:flex; flex-direction:column}
  .track .title{font-size:14px}
  .track .len{font-size:12px; color:var(--muted)}
  .track.playing{box-shadow:0 0 0 2px rgba(255,213,74,.25) inset}
  .track.playing::before{
    content:""; position:absolute; left:0; top:0; bottom:0; width:6px; background:var(--warn); border-radius:12px 0 0 12px;
  }
  .progressBar{
    position:absolute; left:0; bottom:0; height:3px; background:var(--warn); border-radius:0 0 12px 12px; width:0%;
  }

  /* Player */
  .player{
    position:fixed; left:0; right:0; bottom:0; background:var(--panel);
    border-top:1px solid var(--ring); padding:10px; z-index:5;
  }
  .playerCompact .controls{display:flex; align-items:center; gap:6px; flex-wrap:nowrap; overflow:hidden}
  .playerCompact .btn{padding:4px 6px; min-height:32px; min-width:32px; border-radius:10px; font-size:13px}
  .playerCompact .seekWrap{
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:6px; min-width:140px; margin-left:auto;
  }
  .playerCompact #P_times{min-width:76px; font-size:12px; text-align:right}
  .playerCompact #P_times .dur{opacity:.8; margin-left:2px}
  .playerCompact #P_seek{width:100%; max-width:160px}
  .playerCompact #P_seekVis{left:10px; right:120px; max-width:160px}

  /* Hide +/-10s buttons entirely */
  #P_back10, #P_fwd10{ display:none !important; }

  input[type="range"]{
    -webkit-appearance:none; appearance:none; height:4px; border-radius:999px; background:#2a2c30; outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); border:none; box-shadow:0 0 0 3px rgba(91,209,154,.25);
  }

  .sp{flex:1 1 auto}
  .sr{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><a href="#/bands">Live Music Archive</a> <span class="crumb" id="crumb"></span></h1>
  </header>

  <!-- Bands toolbar -->
  <div class="toolbar" id="toolbar-bands">
    <div class="pill">
      <select id="sortSel" aria-label="Sort">
        <option value="downloads desc" selected>Views ‚Üì</option>
        <option value="downloads asc">Views ‚Üë</option>
        <option value="title asc">Title A‚ÜíZ</option>
        <option value="title desc">Title Z‚ÜíA</option>
      </select>
    </div>

    <div class="pill">
      <select id="subjectSel" aria-label="Subject">
        <option value="all" selected>All subjects</option>
      </select>
    </div>

    <div class="pill sp" style="min-width:160px;">
      <input id="searchBox" type="search" placeholder="e.g., Grateful Dead, bluegrass" style="width:100%;">
    </div>

    <button id="favToggle" class="btn">‚òÜ Favorites</button>
    <button id="resetBtn" class="btn ghost muted">Reset</button>
  </div>

  <!-- Band (concerts) toolbar -->
  <div class="toolbar" id="toolbar-band" style="display:none;">
    <button class="btn ghost" id="backToBands" title="Back">‚Üê Bands</button>
    <div class="pill">
      <select id="yearSel" aria-label="Year">
        <option value="">All years</option>
      </select>
    </div>
    <div class="pill sp" style="min-width:160px;">
      <input id="concertSearch" type="search" placeholder="Search concerts" style="width:100%;">
    </div>
  </div>

  <!-- Show (tracklist) toolbar -->
  <div class="toolbar" id="toolbar-show" style="display:none;">
    <button class="btn ghost" id="backToConcerts" title="Back">‚Üê Concerts</button>
    <button class="btn" id="favShowBtn" title="Favorite">‚òÜ Favorite</button>
    <a id="openOnIA" class="btn ghost" target="_blank" rel="noopener">Archive.org</a>
  </div>

  <div id="content" class="grid" aria-live="polite"></div>
</div>

<!-- Player -->
<div class="player playerCompact" id="player">
  <div class="controls">
    <button id="P_prev" class="btn" title="Previous">‚èÆ</button>
    <button id="P_play" class="btn" title="Play/Pause">‚ñ∂Ô∏è</button>
    <button id="P_next" class="btn" title="Next">‚è≠</button>

    <div class="seekWrap">
      <div id="P_times">
        <span class="cur">0:00</span><span class="dur"> / 0:00</span>
      </div>
      <input id="P_seek" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
      <div class="sr" aria-hidden="true" id="P_seekVis"></div>
    </div>

    <button id="P_mute" class="btn" title="Mute">üîà</button>
  </div>
  <audio id="audio"></audio>
</div>

<script>
/* ------------------------------
   Utilities & Local Storage
------------------------------ */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtTime = secs => {
  secs = Math.max(0, Math.floor(secs || 0));
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m + ":" + String(s).padStart(2, "0");
};
function show(el, on=true){ if(!el) return; el.style.display = on ? '' : 'none'; }

const store = {
  get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

/* ------------------------------
   Router
------------------------------ */
const Router = (() => {
  const routes = {};
  function on(name, fn){ routes[name] = fn; }
  function parse(){
    const raw = location.hash.replace(/^#\/?/, '');
    const [name, ...rest] = raw.split('/').filter(Boolean);
    return { name: name || 'bands', params: rest };
  }
  function route(){
    const r = parse();
    (routes[r.name] || routes['bands'])(r.params);
    $('#crumb').textContent = r.name === 'band' ? '‚Äî Concerts' : (r.name === 'show' ? '‚Äî Tracks' : '‚Äî Bands');
  }
  return { on, route };
})();

window.addEventListener('hashchange', Router.route);
document.addEventListener('DOMContentLoaded', Router.route);

/* ------------------------------
   Archive.org helpers
------------------------------ */
const IA = {
  bandsUrl({ q = 'collection:(etree) AND mediatype:(collection)', sort = 'downloads desc', rows = 100, page = 1 } = {}){
    const u = new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q', q);
    u.searchParams.append('fl[]', 'identifier');
    u.searchParams.append('fl[]', 'title');
    u.searchParams.append('fl[]', 'downloads');
    u.searchParams.append('sort[]', sort);
    u.searchParams.set('rows', rows);
    u.searchParams.set('page', page);
    u.searchParams.set('output', 'json');
    return u.toString();
  },
  concertsUrl({ bandId, sort = 'date desc', rows = 500, year = '', term = '' }){
    let q = `collection:(${bandId}) AND mediatype:(etree OR audio)`;
    if (year) q += ` AND year:(${year})`;
    if (term) q += ` AND (title:(${term}) OR date:(${term}))`;

    const u = new URL('https://archive.org/advancedsearch.php');
    u.searchParams.set('q', q);
    u.searchParams.append('fl[]','identifier');
    u.searchParams.append('fl[]','title');
    u.searchParams.append('fl[]','date');
    u.searchParams.append('fl[]','year');
    u.searchParams.append('fl[]','downloads');
    u.searchParams.append('sort[]', sort);
    u.searchParams.set('rows', rows);
    u.searchParams.set('page', 1);
    u.searchParams.set('output', 'json');
    return u.toString();
  },
  concertsYearsUrl({ bandId }){
    // facet by year to get complete list with counts
    const u = new URL('https://archive.org/advancedsearch.php');
    const q = `collection:(${bandId}) AND mediatype:(etree OR audio)`;
    u.searchParams.set('q', q);
    u.searchParams.set('rows', 0);
    u.searchParams.set('page', 1);
    u.searchParams.set('output', 'json');
    u.searchParams.append('facet[]','year');
    u.searchParams.set('facet_limit','10000');
    u.searchParams.set('facet_mincount','1');
    return u.toString();
  },
  metaUrl(id){ return `https://archive.org/metadata/${id}`; },
  imgUrl(id){ return `https://archive.org/services/img/${id}`; },
  async fetchJSON(url){
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Network ' + res.status);
    return res.json();
  }
};

/* ------------------------------
   Bands screen (with small images)
------------------------------ */
async function showBands(){
  show($('#toolbar-bands'), true);
  show($('#toolbar-band'), false);
  show($('#toolbar-show'), false);

  const content = $('#content');
  if (!content) return;
  content.className = 'bandsGrid';
  content.innerHTML = `<div class="card"><span class="small muted">Loading top bands‚Ä¶</span></div>`;

  const sortSel = $('#sortSel');
  const searchBox = $('#searchBox');

  const sort = sortSel?.value || 'downloads desc';
  const term = (searchBox?.value || '').trim();

  let q = 'collection:(etree) AND mediatype:(collection)';
  if (term) q += ` AND (title:(${term}) OR identifier:(${term}))`;

  try{
    const data = await IA.fetchJSON(IA.bandsUrl({ q, sort, rows: 120 }));
    const items = (data?.response?.docs || []).map(d => ({
      id: d.identifier, title: d.title || d.identifier, downloads: d.downloads || 0
    }));

    if (!items.length){
      content.innerHTML = `<div class="card"><span class="small">No results.</span></div>`;
      return;
    }

    content.innerHTML = items.map(b => `
      <div class="bandTile" data-id="${b.id}">
        <img src="${IA.imgUrl(b.id)}" alt="${b.title}">
        <div class="bandTitle">${b.title}</div>
        <div class="bandViews">${b.downloads.toLocaleString()} views</div>
      </div>
    `).join('');

    content.onclick = (ev) => {
      const tile = ev.target.closest('.bandTile');
      if (!tile) return;
      const id = tile.getAttribute('data-id');
      location.hash = '#/band/' + encodeURIComponent(id);
    };
  }catch(err){
    console.error(err);
    content.className = 'grid';
    content.innerHTML = `<div class="card"><span class="small">Failed to load bands. Check network/CORS.</span></div>`;
  }
}

/* ------------------------------
   Band screen (concert list + all-year facet)
------------------------------ */
let currentBandId = '';
let currentConcerts = [];

async function showBand(params){
  show($('#toolbar-bands'), false);
  show($('#toolbar-band'), true);
  show($('#toolbar-show'), false);

  const [idRaw] = params || [];
  const id = decodeURIComponent(idRaw || '');
  currentBandId = id;

  $('#backToBands').onclick = () => location.hash = '#/bands';

  const content = $('#content');
  if (!content) return;
  content.className = 'grid';
  content.innerHTML = `<div class="card"><span class="small muted">Loading concerts for <b>${id}</b>‚Ä¶</span></div>`;

  try{
    // Get years facet (complete list + counts)
    let yearsFacet = [];
    try{
      const facetData = await IA.fetchJSON(IA.concertsYearsUrl({ bandId:id }));
      const facet = facetData?.response?.facets?.year;
      if (facet && typeof facet === 'object'){
        yearsFacet = Object.entries(facet)
          .map(([year,count]) => ({year:Number(year), count:Number(count)}))
          .filter(y => !isNaN(y.year)).sort((a,b)=>b.year-a.year);
      }
    }catch(e){ console.warn('Year facet failed, will build from docs later'); }

    // initial list page (no filter)
    const data = await IA.fetchJSON(IA.concertsUrl({ bandId:id, sort:'date desc', rows:1000 }));
    const docs = (data?.response?.docs || []);
    currentConcerts = docs;

    // If facet failed, fall back to counts from docs
    if (yearsFacet.length === 0){
      const counts = {};
      for (const d of docs){ if (d.year) counts[d.year] = (counts[d.year]||0)+1; }
      yearsFacet = Object.keys(counts).map(y => ({year:Number(y), count:counts[y]}))
        .sort((a,b)=>b.year-a.year);
    }

    // Build Year options (desc with counts)
    const yearSel = $('#yearSel');
    yearSel.innerHTML = `<option value="">All years</option>` + yearsFacet
      .map(y=>`<option value="${y.year}">${y.year} (${y.count.toLocaleString()})</option>`).join('');
    yearSel.onchange = () => renderConcerts();
    $('#concertSearch').onchange = () => renderConcerts();

    renderConcerts();
  }catch(err){
    console.error(err);
    content.innerHTML = `<div class="card"><span class="small">Failed to load concerts.</span></div>`;
  }
}

function renderConcerts(){
  const content = $('#content');
  if (!content) return;
  const year = $('#yearSel')?.value || '';
  const term = ($('#concertSearch')?.value || '').trim().toLowerCase();

  let list = currentConcerts.slice();
  if (year) list = list.filter(d => String(d.year) === String(year));
  if (term) list = list.filter(d => (d.title||'').toLowerCase().includes(term) || (d.date||'').toLowerCase().includes(term));

  if (!list.length){
    content.innerHTML = `<div class="card"><span class="small">No concerts found.</span></div>`;
    return;
  }

  content.innerHTML = list.map(it => {
    const date = it.date ? new Date(it.date).toLocaleDateString() : (it.year || '');
    return `
      <div class="card" data-id="${it.identifier}">
        <div>
          <h3>${it.title || it.identifier}</h3>
          <div class="small muted">${date} ‚Ä¢ ${Number(it.downloads||0).toLocaleString()} views</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn detailsBtn">Details</button>
        </div>
      </div>
    `;
  }).join('');

  content.onclick = (ev) => {
    const card = ev.target.closest('.card');
    if (!card) return;
    if (ev.target.classList.contains('detailsBtn')) {
      const id = card.getAttribute('data-id');
      location.hash = '#/show/' + encodeURIComponent(id);
    }
  };
}

/* ------------------------------
   Show page (tracklist, progress, favorite)
------------------------------ */
let currentShowId = '';
let trackEls = [];
let trackList = []; // {url,title,length}

function isFav(id){
  const favs = store.get('favShows', []);
  return favs.includes(id);
}
function toggleFav(id){
  const favs = store.get('favShows', []);
  const i = favs.indexOf(id);
  if (i >= 0) favs.splice(i,1); else favs.push(id);
  store.set('favShows', favs);
  updateFavBtn();
}
function updateFavBtn(){
  const btn = $('#favShowBtn');
  if (!btn) return;
  btn.textContent = isFav(currentShowId) ? '‚òÖ Favorited' : '‚òÜ Favorite';
}

async function showShow(params){
  show($('#toolbar-bands'), false);
  show($('#toolbar-band'), false);
  show($('#toolbar-show'), true);

  const [idRaw] = params || [];
  const id = decodeURIComponent(idRaw || '');
  currentShowId = id;

  $('#backToConcerts').onclick = () => history.back();
  $('#openOnIA').href = `https://archive.org/details/${encodeURIComponent(id)}`;
  $('#favShowBtn').onclick = () => toggleFav(id);
  updateFavBtn();

  const content = $('#content');
  content.className = 'tracks';
  content.innerHTML = `<div class="card"><span class="small muted">Loading tracks‚Ä¶</span></div>`;

  try{
    const meta = await IA.fetchJSON(IA.metaUrl(id));
    const files = meta?.files || [];
    // prioritize MP3; fallback to OGG/FLAC streams that are HTTP accessible
    const playable = files.filter(f => {
      const fmt = (f.format||'').toLowerCase();
      const name = (f.name||'').toLowerCase();
      return name.endsWith('.mp3') || fmt.includes('mp3') ||
             name.endsWith('.ogg') || fmt.includes('ogg') ||
             name.endsWith('.flac') || fmt.includes('flac');
    });

    trackList = playable.map((f,idx) => {
      const url = `https://archive.org/download/${id}/${encodeURIComponent(f.name)}`;
      const title = f.title || f.name || `Track ${idx+1}`;
      const length = f.length ? f.length : '';
      return { url, title, length };
    });

    if (!trackList.length){
      content.innerHTML = `<div class="card"><span class="small">No playable files found.</span></div>`;
      return;
    }

    content.innerHTML = trackList.map((t,i)=>`
      <div class="track" data-i="${i}">
        <button class="btn playBtn">${i===0?'‚ñ∂Ô∏è':'‚ñ∂Ô∏è'}</button>
        <div class="meta">
          <div class="title">${t.title}</div>
          <div class="len">${t.length}</div>
        </div>
        <div class="progressBar" id="pb-${i}"></div>
      </div>
    `).join('');

    trackEls = $$('.track');
    content.onclick = (ev) => {
      const tr = ev.target.closest('.track');
      if (!tr) return;
      const i = Number(tr.getAttribute('data-i'));
      playIndex(i);
    };
  }catch(e){
    console.error(e);
    content.innerHTML = `<div class="card"><span class="small">Failed to load track list.</span></div>`;
  }
}

/* ------------------------------
   Player logic (shared)
------------------------------ */
const A = $('#audio');
const P = {
  play: $('#P_play'),
  prev: $('#P_prev'),
  next: $('#P_next'),
  mute: $('#P_mute'),
  seek: $('#P_seek'),
  cur: $('#P_times .cur'),
  dur: $('#P_times .dur')
};

let queue = [];
let curIndex = -1;

function setQueueFromTracks(){
  queue = trackList.map(t => t.url);
}

function playIndex(i){
  if (!trackList.length) return;
  setQueueFromTracks();
  curIndex = Math.max(0, Math.min(i, queue.length-1));
  A.src = queue[curIndex];
  A.play().catch(()=>{});
  updateTrackHighlight();
}

function updateTrackHighlight(){
  trackEls.forEach((el,idx)=>{
    el.classList.toggle('playing', idx===curIndex);
  });
}

P.play?.addEventListener('click', () => { if (A.paused) A.play(); else A.pause(); });
P.prev?.addEventListener('click', () => { if (curIndex>0) playIndex(curIndex-1); });
P.next?.addEventListener('click', () => { if (curIndex<queue.length-1) playIndex(curIndex+1); });
P.mute?.addEventListener('click', () => { A.muted = !A.muted; });

P.seek?.addEventListener('input', () => {
  if (!A.duration || isNaN(A.duration)) return;
  const t = (P.seek.value / 1000) * A.duration;
  A.currentTime = t;
});

A.addEventListener('timeupdate', () => {
  if (A.duration && !isNaN(A.duration)) {
    P.cur.textContent = fmtTime(A.currentTime);
    P.dur.textContent = ' / ' + fmtTime(A.duration);
    P.seek.value = Math.floor((A.currentTime / A.duration) * 1000);

    // per-track progress bar on Show page
    if (curIndex>=0){
      const pb = document.getElementById('pb-'+curIndex);
      if (pb) pb.style.width = `${(A.currentTime/A.duration)*100}%`;
    }
  } else {
    P.cur.textContent = '0:00';
    P.dur.textContent = ' / 0:00';
    P.seek.value = 0;
  }
});

A.addEventListener('play',  () => { P.play.textContent = '‚è∏'; updateTrackHighlight(); });
A.addEventListener('pause', () => { P.play.textContent = '‚ñ∂Ô∏è'; });
A.addEventListener('ended', () => {
  if (curIndex < queue.length-1) playIndex(curIndex+1);
});

/* ------------------------------
   Route wiring
------------------------------ */
Router.on('bands', showBands);
Router.on('band', showBand);
Router.on('show', showShow);

/* ------------------------------
   Bands filters
------------------------------ */
$('#sortSel')?.addEventListener('change', showBands);
$('#searchBox')?.addEventListener('change', showBands);
$('#resetBtn')?.addEventListener('click', () => {
  $('#sortSel').value = 'downloads desc';
  $('#searchBox').value = '';
  location.hash = '#/bands';
  showBands();
});

/* ------------------------------
   Service worker (optional)
------------------------------ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(console.warn);
}
</script>
</body>
</html>
